<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Outlook EML ë·°ì–´ (emailjs-mime-parser)</title>

  <!-- âœ… emailjs-mime-parser (ë¸Œë¼ìš°ì €ìš© UMD ë¹Œë“œ) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-mime-parser/dist/emailjs-mime-parser.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(90deg,#1e40af,#0f766e);
      color: white;
      padding: 10px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .title { font-size: 18px; font-weight: 600; }
    .subtitle { font-size: 12px; opacity: .9; }
    .file-box {
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,0.15);
      padding:6px 12px; border-radius:999px;
      font-size: 12px;
    }
    main { display:flex; gap:14px; padding:14px; }

    .sidebar {
      width:260px;
      background:white;
      border-radius:12px;
      padding:10px;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
      height:calc(100vh - 70px);
      overflow:auto;
      font-size:12px;
    }
    .content {
      flex:1;
      height:calc(100vh - 70px);
      overflow:auto;
    }

    .section-title {
      font-weight:600;
      font-size:13px;
      margin:6px 0;
    }
    .msg-item {
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      margin-bottom:4px;
    }
    .msg-item:hover { background:#e5e7eb; }
    .msg-item.active { background:#0f766e; color:white; }

    #dropZone {
      border:2px dashed #9ca3af;
      background:white;
      padding:26px;
      border-radius:12px;
      text-align:center;
      font-size:13px;
      color:#6b7280;
      margin-bottom:12px;
      transition:.2s;
    }
    #dropZone.dragover {
      border-color:#2563eb;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .meta-card, .body-card, .raw-card {
      background:white;
      border-radius:12px;
      padding:12px 14px;
      margin-bottom:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
      font-size:13px;
    }
    .meta-row {
      display:flex;
      margin-bottom:4px;
      gap:8px;
    }
    .meta-label {
      width:70px;
      font-weight:600;
      color:#4b5563;
    }
    .meta-value {
      flex:1;
      white-space:pre-wrap;
      word-break:break-all;
    }

    .body-tabs {
      display:flex;
      gap:6px;
      margin-bottom:8px;
    }
    .tab-btn {
      flex:0 0 auto;
      padding:4px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:white;
      cursor:pointer;
    }
    .tab-btn.active {
      background:#1e40af;
      color:white;
      border-color:#1e40af;
    }
    .body-view {
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:10px;
      background:#f9fafb;
      max-height:600px;
      overflow:auto;
      font-size:13px;
      white-space:pre-wrap;
    }
    .body-view-html {
      background:white;
    }

    details summary {
      cursor:pointer;
      font-size:13px;
      color:#2563eb;
    }

    @media (max-width:900px){
      main{flex-direction:column;}
      .sidebar{width:100%;height:auto;}
      .content{height:auto;}
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">Outlook EML ë·°ì–´</div>
    <div class="subtitle">emailjs-mime-parser ê¸°ë°˜ Â· msgâ†’eml ë³€í™˜ í›„ ì—…ë¡œë“œ</div>
  </div>
  <div class="file-box">
    <span>ğŸ“ íŒŒì¼ ì„ íƒ (.eml)</span>
    <input id="fileInput" type="file" multiple accept=".eml" />
  </div>
</header>

<main>
  <aside class="sidebar">
    <div class="section-title">ë©”ì¼ ëª©ë¡</div>
    <div style="font-size:11px;color:#6b7280; margin-bottom:6px;">
      .eml íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì˜¬ë¦¬ë©´<br>
      ì œëª©/ë°œì‹ /ìˆ˜ì‹ /ë‚´ìš©ì„ ìš°ì¸¡ì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
    <div id="msgList"></div>
  </aside>

  <section class="content">
    <div id="dropZone">
      ì´ê³³ì— .eml íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ì„¸ìš”<br>
      <span style="font-size:11px;color:#9ca3af;">
        ì—¬ëŸ¬ ê°œ ì˜¬ë¦¬ë©´ ì¢Œì¸¡ ëª©ë¡ì— ìˆœì„œëŒ€ë¡œ ìŒ“ì…ë‹ˆë‹¤.
      </span>
    </div>

    <div id="currentInfo" style="font-size:12px;color:#4b5563;margin-bottom:6px;"></div>

    <div id="metaContainer"></div>
    <div id="bodyContainer"></div>
    <div id="rawContainer"></div>
  </section>
</main>

<script>
  // ========= ìƒíƒœ =========
  let messages = [];   // { id, subject, from, to, cc, date, text, html, raw }
  let currentId = null;

  // ========= ìœ í‹¸ =========
  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function formatDateHeader(dateStr) {
    if(!dateStr) return "";
    const d = new Date(dateStr);
    if(isNaN(d)) return dateStr;
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    const h=String(d.getHours()).padStart(2,"0");
    const mi=String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${dd} ${h}:${mi}`;
  }

  // quoted-printable ê°„ë‹¨ ë³µí˜¸í™” (Content-Transfer-Encoding: quoted-printable)
  function decodeQuotedPrintable(input) {
    if(!input) return "";
    return input
      .replace(/=\r?\n/g, "")                 // ì†Œí”„íŠ¸ ë¼ì¸ ë¸Œë ˆì´í¬ ì œê±°
      .replace(/=([0-9A-Fa-f]{2})/g, (m,hex)=>String.fromCharCode(parseInt(hex,16)));
  }

  // ========= emailjs-mime-parser ë¥¼ ì‚¬ìš©í•´ EML íŒŒì‹± =========
  function parseEmlWithEmailJs(emlText) {
    const MimeParser = emailjs.mimeParser.MimeParser;
    const parser = new MimeParser();

    let root = null;
    let textParts = [];
    let htmlParts = [];

    const decoder = new TextDecoder("utf-8");

    parser.onbody = function(node, chunk) {
      // chunk: Uint8Array
      const contentTypeHeader = node.headers.get("content-type");
      let mimeType = "";
      if (contentTypeHeader && contentTypeHeader.length) {
        const h = contentTypeHeader[0];
        mimeType = (h.value || h.initial || "").toLowerCase();
      }

      const raw = decoder.decode(chunk);

      if (mimeType.indexOf("text/html") === 0) {
        htmlParts.push(raw);
      } else if (mimeType.indexOf("text/plain") === 0 || !mimeType) {
        textParts.push(raw);
      }
    };

    parser.onend = function(node) {
      root = node;
    };

    parser.write(emlText);
    parser.end();

    if (!root) return null;

    function getHeader(name) {
      const h = root.headers.get(name.toLowerCase());
      if (!h || !h.length) return "";
      const v = h[0].value || h[0].initial || "";
      return String(v);
    }

    let textBody = textParts.join("\n");
    let htmlBody = htmlParts.join("\n");

    // Content-Transfer-Encoding í™•ì¸í•´ì„œ quoted-printable ì´ë©´ ë³µí˜¸í™”
    const cteHeader = root.headers.get("content-transfer-encoding");
    const cte = cteHeader && cteHeader.length
      ? String(cteHeader[0].value || cteHeader[0].initial || "").toLowerCase()
      : "";

    if (cte.includes("quoted-printable")) {
      textBody = decodeQuotedPrintable(textBody);
      htmlBody = decodeQuotedPrintable(htmlBody);
    }

    return {
      subject: getHeader("subject") || "(ì œëª© ì—†ìŒ)",
      from: getHeader("from"),
      to: getHeader("to"),
      cc: getHeader("cc"),
      date: getHeader("date"),
      text: textBody,
      html: htmlBody,
      raw: emlText
    };
  }

  // ========= ë Œë”ë§ =========
  const msgListEl = document.getElementById("msgList");
  const metaContainer = document.getElementById("metaContainer");
  const bodyContainer = document.getElementById("bodyContainer");
  const rawContainer  = document.getElementById("rawContainer");
  const currentInfo   = document.getElementById("currentInfo");

  function renderList() {
    msgListEl.innerHTML = "";
    messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "msg-item" + (msg.id === currentId ? " active" : "");
      const shortSubj = msg.subject.length > 40 ? msg.subject.slice(0,40) + "â€¦" : msg.subject;
      div.innerHTML = `
        <div style="font-weight:600">${escapeHtml(shortSubj)}</div>
        <div style="font-size:11px;color:#6b7280">${escapeHtml(msg.from || "")}</div>
        <div style="font-size:11px;color:#9ca3af">${escapeHtml(formatDateHeader(msg.date))}</div>
      `;
      div.onclick = () => {
        currentId = msg.id;
        renderList();
        renderCurrent();
      };
      msgListEl.appendChild(div);
    });
  }

  function renderCurrent() {
    const msg = messages.find(m => m.id === currentId);
    if (!msg) {
      currentInfo.textContent = messages.length
        ? "ì™¼ìª½ì—ì„œ ë©”ì¼ì„ ì„ íƒí•˜ì„¸ìš”."
        : "ì—…ë¡œë“œëœ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
      metaContainer.innerHTML = "";
      bodyContainer.innerHTML = "";
      rawContainer.innerHTML  = "";
      return;
    }

    currentInfo.textContent = `ì„ íƒëœ ë©”ì¼: ${msg.subject}`;

    // ë©”íƒ€
    metaContainer.innerHTML = `
      <div class="meta-card">
        <div class="meta-row">
          <div class="meta-label">ì œëª©</div>
          <div class="meta-value">${escapeHtml(msg.subject)}</div>
        </div>
        <div class="meta-row">
          <div class="meta-label">ë³´ë‚¸ ì‚¬ëŒ</div>
          <div class="meta-value">${escapeHtml(msg.from)}</div>
        </div>
        <div class="meta-row">
          <div class="meta-label">ë°›ëŠ” ì‚¬ëŒ</div>
          <div class="meta-value">${escapeHtml(msg.to)}</div>
        </div>
        <div class="meta-row">
          <div class="meta-label">ì°¸ì¡°</div>
          <div class="meta-value">${escapeHtml(msg.cc)}</div>
        </div>
        <div class="meta-row">
          <div class="meta-label">ë‚ ì§œ</div>
          <div class="meta-value">${escapeHtml(formatDateHeader(msg.date))}</div>
        </div>
      </div>
    `;

    // ë³¸ë¬¸ íƒ­
    const hasHtml = !!msg.html.trim();
    const hasText = !!msg.text.trim();

    let activeTab = hasHtml ? "html" : "text";

    function renderBodyTab() {
      const isHtml = activeTab === "html";
      const htmlTabClass = "tab-btn" + (isHtml ? " active" : "");
      const textTabClass = "tab-btn" + (!isHtml ? " active" : "");
      const bodyHtml = isHtml
        ? (msg.html ? msg.html : "<p>(HTML ë³¸ë¬¸ ì—†ìŒ)</p>")
        : `<pre style="margin:0;white-space:pre-wrap;">${escapeHtml(msg.text || "(í…ìŠ¤íŠ¸ ë³¸ë¬¸ ì—†ìŒ)")}</pre>`;

      bodyContainer.innerHTML = `
        <div class="body-card">
          <div class="body-tabs">
            ${hasHtml ? `<button id="tabHtml" class="${htmlTabClass}">HTML</button>` : ""}
            ${hasText ? `<button id="tabText" class="${textTabClass}">í…ìŠ¤íŠ¸</button>` : ""}
          </div>
          <div class="body-view ${isHtml ? "body-view-html" : ""}" id="bodyView">
            ${isHtml ? bodyHtml : bodyHtml}
          </div>
        </div>
      `;

      if (hasHtml) {
        document.getElementById("tabHtml").onclick = () => { activeTab = "html"; renderBodyTab(); };
      }
      if (hasText) {
        document.getElementById("tabText").onclick = () => { activeTab = "text"; renderBodyTab(); };
      }
    }

    renderBodyTab();

    // Raw
    rawContainer.innerHTML = `
      <div class="raw-card">
        <details>
          <summary>ì›ë³¸ MIME ë³´ê¸°</summary>
          <pre style="margin-top:8px;white-space:pre-wrap;font-size:11px;">${escapeHtml(msg.raw)}</pre>
        </details>
      </div>
    `;
  }

  // ========= íŒŒì¼ ì½ê¸° =========
  function handleFiles(fileList) {
    if (!fileList || !fileList.length) return;

    const files = Array.from(fileList);
    let remaining = files.length;

    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const emlText = ev.target.result;
          const parsed = parseEmlWithEmailJs(emlText);
          if (parsed) {
            messages.push({
              id: Date.now() + "_" + Math.random().toString(16).slice(2),
              ...parsed
            });
          } else {
            console.warn("íŒŒì‹± ì‹¤íŒ¨: ", file.name);
          }
        } catch (e) {
          console.error("íŒŒì‹± ì¤‘ ì˜¤ë¥˜:", file.name, e);
        } finally {
          remaining--;
          if (remaining === 0) {
            // ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
            messages.sort((a,b) => {
              const ta = new Date(a.date).getTime() || 0;
              const tb = new Date(b.date).getTime() || 0;
              return ta - tb;
            });
            if (!currentId && messages.length) {
              currentId = messages[messages.length - 1].id; // ê°€ì¥ ë§ˆì§€ë§‰ ë©”ì¼ ì„ íƒ
            }
            renderList();
            renderCurrent();
          }
        }
      };
      reader.readAsText(file);   // EML ì€ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°
    });
  }

  // ========= ì´ë²¤íŠ¸ ë°”ì¸ë”© =========
  const fileInput = document.getElementById("fileInput");
  const dropZone  = document.getElementById("dropZone");

  fileInput.addEventListener("change", e => handleFiles(e.target.files));

  window.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });
  window.addEventListener("dragleave", e => {
    dropZone.classList.remove("dragover");
  });
  window.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
  });

  // ì´ˆê¸° ìƒíƒœ ë¬¸êµ¬
  renderCurrent();
</script>

</body>
</html>

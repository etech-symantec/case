<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Outlook ì¼€ì´ìŠ¤ ë¶„ì„ê¸° (GitHub í† í° ì…ë ¥)</title>

  <!-- MSG Reader -->
  <script src="https://cdn.jsdelivr.net/gh/ykarpovich/msg.reader/msg.reader.js"></script>

  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#1e40af;
      color:white;
      padding:14px 20px;
      font-size:18px;
      font-weight:600;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    main{display:flex;gap:16px;padding:16px;}
    .sidebar{
      width:260px;
      padding:12px;
      background:white;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      overflow:auto;
      height:calc(100vh - 80px);
      font-size:13px;
    }
    .content{
      flex:1;
      height:calc(100vh - 80px);
      overflow:auto;
    }

    .btn{
      width:100%;padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:white;
      cursor:pointer;
      font-size:13px;
      margin-top:6px;
    }
    .btn:hover{background:#f3f4f6;}

    .case-item{
      padding:8px;border-radius:8px;
      cursor:pointer;margin:4px 0;
    }
    .case-item:hover{background:#e5e7eb;}
    .case-item.active{background:#1d4ed8;color:white;}

    #dropZone{
      border:2px dashed #9ca3af;
      background:white;
      padding:30px;border-radius:12px;
      text-align:center;font-size:13px;
      color:#6b7280;margin-bottom:12px;
      transition:.2s;
    }
    #dropZone.dragover{
      border-color:#2563eb;
      background:#eff6ff;
      color:#1e40af;
    }

    .search-input{
      width:100%;padding:8px 12px;
      border-radius:999px;border:1px solid #d1d5db;
      font-size:13px;
    }

    .mail-card{
      background:white;border-radius:12px;
      padding:12px;margin-bottom:12px;
      box-shadow:0 1px 4px rgba(0,0,0,.08);
      border-left:3px solid #e5e7eb;
    }

    .summary-card{
      background:#fefce8;border:1px solid #facc15;
      padding:12px;border-radius:12px;
      margin-bottom:16px;white-space:pre-wrap;
    }

    .pill{
      display:inline-block;padding:2px 6px;
      font-size:11px;border-radius:999px;
      background:#f3f4f6;margin-right:4px;margin-top:4px;
    }
  </style>
</head>

<body>

<header>Outlook ì¼€ì´ìŠ¤ ë¶„ì„ê¸° (GitHub ì—°ë™)</header>

<main>
  <aside class="sidebar">

    <!-- ğŸ”¥ í† í° ì…ë ¥ UI ì¶”ê°€ë¨ -->
    <div style="font-weight:600;margin-bottom:4px;">GitHub í† í° ì…ë ¥</div>
    <input id="ghToken" type="password"
           style="width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;"
           placeholder="Personal Access Token (PAT)">
    <button id="saveTokenBtn" class="btn">í† í° ì €ì¥</button>

    <button id="btnLoadCasesGh" class="btn" style="margin-top:14px;">
      ğŸ”„ GitHubì—ì„œ ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
    </button>

    <hr style="margin:12px 0;">

    <div style="font-weight:600;">ì¼€ì´ìŠ¤ ëª©ë¡</div>
    <div id="caseList"></div>

    <button id="addCaseBtn" class="btn" style="margin-top:12px;">â• ìƒˆ ì¼€ì´ìŠ¤ ë§Œë“¤ê¸°</button>

    <hr style="margin:12px 0;">

    <div style="font-weight:600;">ë³´ê¸° ëª¨ë“œ</div>
    <button id="btnTimeline" class="btn" style="background:#dbeafe;">ì „ì²´ íƒ€ì„ë¼ì¸</button>
    <button id="btnThread" class="btn">ìŠ¤ë ˆë“œ ë³´ê¸°</button>

    <hr style="margin:12px 0;">
    <div style="font-weight:600;">ìŠ¤ë ˆë“œ ëª©ë¡</div>
    <div id="threadList"></div>

    <hr style="margin:12px 0;">
    <div id="statsBox"></div>

  </aside>

  <section class="content">
    <div id="dropZone">ğŸ“¥ ì—¬ê¸°ì— .msg / .eml íŒŒì¼ ë“œë˜ê·¸</div>
    <input id="fileInput" type="file" multiple accept=".msg,.eml"
      style="margin-bottom:10px;">

    <input id="searchInput" class="search-input" placeholder="ê²€ìƒ‰ (ì œëª© / ë³¸ë¬¸ / ë³´ë‚¸ì‚¬ëŒ ...)" style="margin-bottom:10px;">

    <div id="viewInfo" style="margin:8px 0;"></div>

    <div id="summaryContainer"></div>
    <div id="mailContainer"></div>
  </section>
</main>

<script>
// ==============================
//  GitHub ê³ ì • ì„¤ì •
// ==============================
let githubConfig = {
  username: "etech-symantec",
  repo: "case",
  branch: "main",
  token: "" // ğŸ”¥ í† í°ì€ localStorageì—ì„œ ë¶ˆëŸ¬ì˜´
};

// ==============================
//  í† í° LocalStorage ë¡œë“œ
// ==============================
function loadToken() {
  const saved = localStorage.getItem("githubToken");
  if (saved) {
    githubConfig.token = saved;
    document.getElementById("ghToken").value = saved;
  }
}

// ==============================
//  í† í° ì €ì¥ ë²„íŠ¼
// ==============================
document.addEventListener("DOMContentLoaded", () => {
  const tokenInput = document.getElementById("ghToken");
  const saveTokenBtn = document.getElementById("saveTokenBtn");

  saveTokenBtn.addEventListener("click", () => {
    const t = tokenInput.value.trim();
    if (!t) {
      alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    localStorage.setItem("githubToken", t);
    githubConfig.token = t;
    alert("í† í°ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.");
  });
});

// ==============================
//  ì „ì—­ ìƒíƒœ
// ==============================
let casesMeta = [];
let caseData = {};
let currentCaseId = null;

let allEmails = [];
let threads = [];
let currentView = "timeline";
let currentThreadKey = null;

// ==============================
//  GitHub ìœ í‹¸ í•¨ìˆ˜
// ==============================
function encodeBase64Utf8(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function decodeBase64Utf8(b64){
  return decodeURIComponent(escape(atob(b64)));
}

function githubHeaders(){
  return {
    "Accept": "application/vnd.github+json",
    "Authorization": "Bearer " + githubConfig.token
  };
}

function githubContentUrl(path){
  return `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${path}`;
}

// ==============================
//  GitHub GET JSON
// ==============================
async function githubGetJSON(path){
  const url = githubContentUrl(path) + `?ref=${githubConfig.branch}`;
  const res = await fetch(url, { headers: githubHeaders() });

  if(res.status === 404) return null;
  if(!res.ok) throw new Error("GitHub GET ì‹¤íŒ¨: " + res.status);

  const data = await res.json();
  const decoded = decodeBase64Utf8(data.content);
  return JSON.parse(decoded);
}

// ==============================
//  GitHub PUT JSON
// ==============================
async function githubPutJSON(path, obj, msg){
  if (!githubConfig.token) throw new Error("GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");

  const url = githubContentUrl(path);
  let sha = null;

  // ê¸°ì¡´ íŒŒì¼ SHA ì²´í¬
  const check = await fetch(url, { headers: githubHeaders() });
  if (check.status === 200) {
    const j = await check.json();
    sha = j.sha;
  }

  const body = {
    message: msg || "update",
    content: encodeBase64Utf8(JSON.stringify(obj, null, 2)),
    branch: githubConfig.branch
  };
  if (sha) body.sha = sha;

  const res = await fetch(url, {
    method: "PUT",
    headers: { ...githubHeaders(), "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const t = await res.text();
    throw new Error("GitHub PUT ì‹¤íŒ¨: " + res.status + " " + t);
  }

  return await res.json();
}

// ==============================
//  ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
// ==============================
async function refreshCasesFromGithub(){
  try {
    if (!githubConfig.token) {
      alert("ë¨¼ì € í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const list = await githubGetJSON("cases/index.json");
    if (!list) {
      casesMeta = [];
      caseList.textContent = "";
      statsBox.textContent = "GitHubì— ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    casesMeta = list;
    renderCaseList();
    statsBox.textContent = "ì¼€ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
  } catch(e) {
    alert("ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
  }
}

// ==============================
//  ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
// ==============================
async function loadCaseIntoViewer(caseId){
  if (caseData[caseId]) {
    allEmails = caseData[caseId].emails || [];
    postProcessEmails();
    return;
  }

  try {
    const obj = await githubGetJSON(`cases/${caseId}.json`);
    if (!obj) { alert("ì¼€ì´ìŠ¤ ë°ì´í„° ì—†ìŒ"); return; }
    caseData[caseId] = obj;
    allEmails = obj.emails || [];
    postProcessEmails();
  } catch(e) {
    alert("ì¼€ì´ìŠ¤ ë¡œë”© ì‹¤íŒ¨: " + e.message);
  }
}

// ==============================
//  ì¼€ì´ìŠ¤ GitHub ì €ì¥
// ==============================
async function saveCurrentCaseToGithub(showAlert=true){
  if (!currentCaseId) return;
  const meta = casesMeta.find(x => x.id === currentCaseId);
  if (!meta) return;

  const obj = {
    id: currentCaseId,
    name: meta.name,
    emails: allEmails
  };
  caseData[currentCaseId] = obj;

  await githubPutJSON(`cases/${currentCaseId}.json`, obj,
    `Update case ${meta.name}`);

  await githubPutJSON(`cases/index.json`, casesMeta,
    "Update case index");

  if (showAlert) alert("GitHub ì €ì¥ ì™„ë£Œ");
}

// ==============================
//  ë©”ì¼ íŒŒì‹± ë° ë³€í™˜
// ==============================
function normalizeSubject(subject){
  if(!subject) return "(no-subject)";
  let s = subject.toLowerCase();
  s = s.replace(/^(re|fw|fwd|íšŒì‹ |ë‹µì¥|ì „ë‹¬)\s*:\s*/gi, "");
  s = s.replace(/^\[.*?\]\s*/g, "");
  s = s.trim();
  return s || "(no-subject)";
}

function makePreview(body){
  if(!body) return "(ë³¸ë¬¸ ì—†ìŒ)";
  const lines = body.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const first = lines.slice(0,3).join(" ");
  return first.length > 260 ? first.slice(0,260)+"â€¦" : first;
}

// ==============================
//  MSG â†’ í‘œì¤€ ë©”ì¼ êµ¬ì¡°
// ==============================
function convertMsgToEmail(data, filename){
  const subject = data.subject || "(ì œëª© ì—†ìŒ)";

  let from = "";
  if (data.senderEmail || data.senderName) {
    if (data.senderEmail && data.senderName)
      from = `${data.senderName} <${data.senderEmail}>`;
    else from = data.senderEmail || data.senderName;
  }

  let to = "";
  if (Array.isArray(data.recipients)) {
    to = data.recipients
      .map(r => r.email ? `${r.name||""} <${r.email}>` : r.name || "")
      .join("; ");
  }

  let body = data.body || "";
  if (!body && data.bodyHtml)
    body = data.bodyHtml.replace(/<\/?[^>]+>/g, "");

  body = (body || "").trim();

  let dateStr = "", dateObj = new Date(NaN);
  if (data.headers) {
    const m = data.headers.match(/^Date:\s*(.+)$/mi);
    if (m) {
      dateStr = m[1].trim();
      const d = new Date(dateStr);
      if (!isNaN(d)) dateObj = d;
    }
  }

  if (!dateStr && data.messageDeliveryTime) {
    dateStr = data.messageDeliveryTime;
    const d = new Date(dateStr);
    if (!isNaN(d)) dateObj = d;
  }

  return {
    sourceType: "msg",
    filename, subject, from, to,
    dateStr, dateObj,
    body,
    preview: makePreview(body),
    threadKey: normalizeSubject(subject)
  };
}

// ==============================
//  EML â†’ í‘œì¤€ ë©”ì¼ êµ¬ì¡°
// ==============================
function parseEml(raw, filename){
  const parts = raw.split(/\r?\n\r?\n/);
  let headers = parts[0] || "";
  let bodyText = parts.slice(1).join("\n\n") || "";

  headers = headers.replace(/(\r?\n)(\t| )+/g, " ");

  function getHeader(name){
    const re = new RegExp("^"+name+"\\s*:\\s*(.+)$","im");
    const m = headers.match(re);
    return m ? m[1].trim() : "";
  }

  const subject = getHeader("Subject") || "(ì œëª© ì—†ìŒ)";
  const from    = getHeader("From");
  const to      = getHeader("To");
  const dateStr = getHeader("Date");
  const dateObj = dateStr ? new Date(dateStr) : new Date(NaN);

  let body = bodyText.replace(/^\s*>.*$/gm, "").trim();

  return {
    sourceType: "eml",
    filename, subject, from, to,
    dateStr, dateObj,
    body,
    preview: makePreview(body),
    threadKey: normalizeSubject(subject)
  };
}
</script>

<script>
// ==============================
//  ìŠ¤ë ˆë“œ/íƒ€ì„ë¼ì¸ í›„ì²˜ë¦¬ & ë Œë”ë§
// ==============================
function buildThreads(){
  const map = new Map();
  allEmails.forEach(m=>{
    const key = m.threadKey || "(no-subject)";
    if(!map.has(key)){
      map.set(key,{threadKey:key,subject:m.subject,items:[]});
    }
    map.get(key).items.push(m);
  });
  threads = Array.from(map.values());
}

function updateStats(){
  const total = allEmails.length;
  const threadCount = threads.length;
  statsBox.textContent = `ë©”ì¼: ${total}í†µ / ìŠ¤ë ˆë“œ: ${threadCount}ê°œ`;
}

function renderThreadList(){
  threadList.innerHTML = "";
  threads.forEach(t=>{
    const div = document.createElement("div");
    div.className = "case-item" + (t.threadKey===currentThreadKey ? " active":"");
    div.textContent = `${t.subject} (${t.items.length})`;
    div.addEventListener("click",()=>{
      currentThreadKey = t.threadKey;
      currentView = "thread";
      render();
      renderThreadList();
    });
    threadList.appendChild(div);
  });
}

function formatDateTime(d){
  if(!(d instanceof Date) || isNaN(d)) return "ë‚ ì§œ ì •ë³´ ì—†ìŒ";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd= String(d.getDate()).padStart(2,"0");
  const h = String(d.getHours()).padStart(2,"0");
  const mi= String(d.getMinutes()).padStart(2,"0");
  return `${y}-${m}-${dd} ${h}:${mi}`;
}

function buildThreadSummary(list){
  if(!list.length) return "";
  const first = list[0];
  const last  = list[list.length-1];
  let s = "";
  s += `ê¸°ê°„: ${formatDateTime(first.dateObj)} ~ ${formatDateTime(last.dateObj)}\n`;
  s += `ë©”ì¼ ìˆ˜: ${list.length}í†µ\n\n`;
  s += "íë¦„:\n";
  list.forEach((m,i)=>{
    s += `  [${i+1}] ${m.preview}\n`;
  });
  return s;
}

function escapeHtml(str){
  if(str==null) return "";
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

function postProcessEmails(){
  if(!allEmails.length){
    statsBox.textContent = "ë©”ì¼ ì—†ìŒ";
    mailContainer.innerHTML = "";
    summaryContainer.innerHTML = "";
    viewInfo.textContent = "";
    threadList.innerHTML = "";
    return;
  }
  allEmails.sort((a,b)=>{
    const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
    const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
    return t1 - t2;
  });
  buildThreads();
  updateStats();
  renderThreadList();
  render();
}

function render(){
  let list;
  if(currentView==="thread" && currentThreadKey){
    const th = threads.find(x=>x.threadKey===currentThreadKey);
    list = th ? [...th.items] : [];
  }else{
    list = [...allEmails];
  }

  const kw = (searchInput.value||"").toLowerCase().trim();
  if(kw){
    list = list.filter(m=>
      (m.subject+m.body+m.from+m.to).toLowerCase().includes(kw)
    );
  }

  list.sort((a,b)=>{
    const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
    const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
    return t1 - t2;
  });

  viewInfo.textContent =
    currentView === "timeline"
      ? `ì „ì²´ íƒ€ì„ë¼ì¸ Â· ${list.length}í†µ`
      : `ìŠ¤ë ˆë“œ ë³´ê¸° Â· ${list.length}í†µ`;

  summaryContainer.innerHTML = "";
  if(currentView==="thread" && list.length){
    const sum = buildThreadSummary(list);
    const div = document.createElement("div");
    div.className = "summary-card";
    div.innerHTML = "<b>ìŠ¤ë ˆë“œ ìš”ì•½</b>\n" + escapeHtml(sum);
    summaryContainer.appendChild(div);
  }

  mailContainer.innerHTML = "";
  list.forEach((m,idx)=>{
    const card = document.createElement("div");
    card.className = "mail-card";
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;margin-bottom:4px;">
        <div>
          <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(m.subject)}</div>
          <div style="font-size:12px;color:#4b5563;">
            From: ${escapeHtml(m.from||"")}<br>
            To: ${escapeHtml(m.to||"")}
          </div>
        </div>
        <div style="font-size:12px;color:#374151;white-space:nowrap;">
          ${escapeHtml(formatDateTime(m.dateObj))}
        </div>
      </div>
      <div style="font-size:13px;white-space:pre-wrap;margin-top:6px;">
        ${escapeHtml(m.preview)}
        <span class="clickable" data-id="toggle-${idx}"
          style="color:#2563eb;cursor:pointer;">ë”ë³´ê¸°</span>
      </div>
      <div class="mail-body-full" id="full-${idx}"
           style="display:none;border-top:1px dashed #e5e7eb;margin-top:6px;padding-top:6px;white-space:pre-wrap;">
${escapeHtml(m.body||"")}
      </div>
      <div style="margin-top:4px;">
        <span class="pill">${escapeHtml(m.filename||"")}</span>
        <span class="pill">${(m.sourceType||"").toUpperCase()}</span>
      </div>
    `;
    const toggle = card.querySelector(`[data-id="toggle-${idx}"]`);
    const full   = card.querySelector(`#full-${idx}`);
    toggle.addEventListener("click",()=>{
      const show = full.style.display==="block";
      full.style.display = show ? "none" : "block";
      toggle.textContent = show ? "ë”ë³´ê¸°" : "ì ‘ê¸°";
    });
    mailContainer.appendChild(card);
  });
}

// ==============================
//  ì¼€ì´ìŠ¤ ëª©ë¡ ë Œë”ë§
// ==============================
function renderCaseList(){
  caseList.innerHTML = "";
  casesMeta.forEach(c=>{
    const div = document.createElement("div");
    div.className = "case-item" + (c.id===currentCaseId ? " active":"");
    div.textContent = c.name;
    div.addEventListener("click",()=>{
      currentCaseId = c.id;
      renderCaseList();
      loadCaseIntoViewer(c.id);
    });
    caseList.appendChild(div);
  });
}

// ==============================
//  íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
// ==============================
function handleFiles(files){
  if(!currentCaseId){
    alert("ë¨¼ì € ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•˜ì„¸ìš”.");
    return;
  }

  console.log("ğŸ“¥ handleFiles() í˜¸ì¶œë¨, íŒŒì¼ ê°œìˆ˜:", files.length);

  allEmails = [];
  threads = [];
  currentThreadKey = null;
  statsBox.textContent = "íŒŒì¼ ì½ëŠ” ì¤‘â€¦";

  if(!files || !files.length) return;
  let remaining = files.length;

  files.forEach(file=>{
    const name = file.name || "";
    const ext  = name.split(".").pop().toLowerCase();

    console.log("â¡ íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:", name, "í™•ì¥ì:", ext);

    const reader = new FileReader();

    reader.onload = ev=>{
      console.log("ğŸ” íŒŒì¼ ë¡œë”© ì„±ê³µ:", name);

      try{
        if(ext==="msg"){
          const buffer = ev.target.result;
          const msgReader = new MSGReader(buffer);
          const data = msgReader.getFileData();
          console.log("âœ” MSG íŒŒì‹± ì„±ê³µ:", name, data);
          allEmails.push(convertMsgToEmail(data, name));
        }else{
          const raw = ev.target.result;
          console.log("âœ” EML í…ìŠ¤íŠ¸ ë¡œë”© ì„±ê³µ:", raw.slice(0,200));
          allEmails.push(parseEml(raw, name));
        }
      }catch(e){
        console.error("âŒ íŒŒì‹± ì‹¤íŒ¨:", name, e);
      }finally{
        remaining--;
        if(remaining===0){
          console.log("ğŸ‰ ëª¨ë“  íŒŒì¼ íŒŒì‹± ì™„ë£Œ:", allEmails);
          postProcessEmails();
          saveCurrentCaseToGithub(false).catch(err=>{
            console.error("GitHub ì €ì¥ ì˜¤ë¥˜:", err);
            alert("GitHub ì €ì¥ ì¤‘ ì˜¤ë¥˜: " + err.message);
          });
        }
      }
    };

    if(ext==="msg") reader.readAsArrayBuffer(file);
    else reader.readAsText(file,"utf-8");
  });
}


// ==============================
//  DOM ì°¸ì¡° & ì´ë²¤íŠ¸ ë°”ì¸ë”©
// ==============================
const caseList         = document.getElementById("caseList");
const statsBox         = document.getElementById("statsBox");
const threadList       = document.getElementById("threadList");
const dropZone         = document.getElementById("dropZone");
const fileInput        = document.getElementById("fileInput");
const searchInput      = document.getElementById("searchInput");
const viewInfo         = document.getElementById("viewInfo");
const summaryContainer = document.getElementById("summaryContainer");
const mailContainer    = document.getElementById("mailContainer");
const btnTimeline      = document.getElementById("btnTimeline");
const btnThread        = document.getElementById("btnThread");
const addCaseBtn       = document.getElementById("addCaseBtn");
const btnLoadCasesGh   = document.getElementById("btnLoadCasesGh");

// GitHubì—ì„œ ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
btnLoadCasesGh.addEventListener("click",()=>{
  refreshCasesFromGithub();
});

// ìƒˆ ì¼€ì´ìŠ¤ ë§Œë“¤ê¸°
addCaseBtn.addEventListener("click",()=>{
  const name = prompt("ì¼€ì´ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
  if(!name) return;
  const id = "case_" + Date.now();
  casesMeta.push({id,name});
  currentCaseId = id;
  caseData[id] = {id,name,emails:[]};
  renderCaseList();
  statsBox.textContent = "ìƒˆ ì¼€ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼ ì—…ë¡œë“œ ì‹œ GitHubì— ì €ì¥ë©ë‹ˆë‹¤.";
});

// íŒŒì¼ ì„ íƒ
fileInput.addEventListener("change",e=>{
  const files = Array.from(e.target.files||[]);
  handleFiles(files);
});

// ë“œë˜ê·¸&ë“œë
window.addEventListener("dragover",e=>{
  e.preventDefault();
  dropZone.classList.add("dragover");
});
window.addEventListener("dragleave",()=>{
  dropZone.classList.remove("dragover");
});
window.addEventListener("drop",e=>{
  e.preventDefault();
  dropZone.classList.remove("dragover");
  const files = Array.from(e.dataTransfer.files||[]);
  handleFiles(files);
});

// ë³´ê¸° ëª¨ë“œ ì „í™˜
btnTimeline.addEventListener("click",()=>{
  currentView = "timeline";
  currentThreadKey = null;
  btnTimeline.style.background = "#dbeafe";
  btnThread.style.background   = "white";
  render();
});
btnThread.addEventListener("click",()=>{
  currentView = "thread";
  btnThread.style.background   = "#dbeafe";
  btnTimeline.style.background = "white";
  render();
});

// ê²€ìƒ‰
searchInput.addEventListener("input",()=>render());

// ì´ˆê¸° ìƒíƒœ
loadToken(); // ğŸ”¥ ì €ì¥ë¼ ìˆë˜ í† í° ìë™ ë¡œë“œ
statsBox.textContent = "ë¨¼ì € í† í°ì„ ì…ë ¥ í›„, GitHubì—ì„œ ì¼€ì´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆ ì¼€ì´ìŠ¤ë¥¼ ë§Œë“œì„¸ìš”.";
</script>

</body>
</html>

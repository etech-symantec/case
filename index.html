<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Outlook ë©”ì¼ íƒ€ì„ë¼ì¸ & ìš”ì•½ ë·°ì–´ (.msg / .eml)</title>

  <!-- âœ… MSGReader: Outlook .msg íŒŒì„œ (GitHub jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/gh/ykarpovich/msg.reader/msg.reader.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(90deg,#1d4ed8,#0f766e);
      color:white;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    header .title { font-size:18px; font-weight:600; }
    header .subtitle { font-size:12px; opacity:0.9; }

    .file-box {
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(15,23,42,0.35);
      border-radius:999px;
      padding:6px 12px;
      font-size:11px;
    }
    .file-box input[type="file"] {
      font-size:11px;
    }

    main {
      display:flex;
      gap:16px;
      padding:16px;
    }
    .sidebar {
      width:260px;
      max-height:calc(100vh - 64px);
      overflow:auto;
      background:white;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.07);
      padding:12px;
      font-size:12px;
    }
    .content {
      flex:1;
      max-height:calc(100vh - 64px);
      overflow:auto;
    }

    .section-title {
      font-weight:600;
      margin:4px 0;
      font-size:13px;
    }
    #statsBox {
      background:#eff6ff;
      border-radius:8px;
      padding:8px;
      line-height:1.5;
    }

    .toggle-group {
      display:flex;
      gap:4px;
      margin:6px 0 10px;
    }
    .toggle-btn {
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:white;
      font-size:12px;
      cursor:pointer;
    }
    .toggle-btn.active {
      background:#1d4ed8;
      color:white;
      border-color:#1d4ed8;
    }

    .thread-list { margin-top:4px; }
    .thread-item {
      padding:6px;
      border-radius:8px;
      cursor:pointer;
      margin-bottom:4px;
    }
    .thread-item:hover { background:#f3f4f6; }
    .thread-item.active { background:#1d4ed8; color:white; }
    .thread-subject {
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .thread-meta {
      font-size:11px;
      opacity:0.9;
    }

    /* Drop Zone */
    #dropZone {
      border:2px dashed #9ca3af;
      border-radius:12px;
      padding:32px;
      text-align:center;
      margin-bottom:14px;
      font-size:13px;
      color:#6b7280;
      background:white;
      transition:all .2s ease;
    }
    #dropZone.dragover {
      border-color:#2563eb;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .controls-row {
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .search-input {
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
    }
    .small-btn {
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:white;
      cursor:pointer;
    }
    .small-btn:hover { background:#f3f4f6; }

    #viewInfo {
      font-size:11px;
      color:#6b7280;
      margin-bottom:6px;
    }

    .summary-card {
      background:#fefce8;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid #facc15;
      margin-bottom:10px;
      font-size:12px;
      white-space:pre-wrap;
    }
    .summary-title {
      font-weight:600;
      margin-bottom:4px;
      font-size:12px;
    }
    .summary-hint {
      font-size:11px;
      color:#6b7280;
      margin-top:4px;
    }

    .mail-card {
      background:white;
      border-radius:12px;
      margin-bottom:10px;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
      padding:10px 12px;
      border-left:3px solid #e5e7eb;
      font-size:12px;
    }
    .mail-header {
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .mail-subject {
      font-size:13px;
      font-weight:600;
      margin-bottom:2px;
    }
    .mail-meta {
      font-size:11px;
      color:#6b7280;
      line-height:1.4;
    }
    .mail-date {
      font-size:11px;
      color:#4b5563;
      white-space:nowrap;
    }
    .mail-body-preview {
      margin-top:6px;
      color:#374151;
      white-space:pre-wrap;
    }
    .mail-body-full {
      margin-top:6px;
      border-top:1px dashed #e5e7eb;
      padding-top:6px;
      white-space:pre-wrap;
      display:none;
      color:#111827;
    }
    .mail-tags {
      margin-top:6px;
      font-size:11px;
      color:#6b7280;
    }
    .pill {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      margin-right:4px;
      margin-top:2px;
    }
    .clickable {
      color:#2563eb;
      cursor:pointer;
      text-decoration:underline;
      text-decoration-style:dotted;
    }
    .empty-state {
      padding:24px;
      text-align:center;
      font-size:12px;
      color:#6b7280;
    }

    @media (max-width:900px) {
      main { flex-direction:column; }
      .sidebar { width:100%; max-height:none; order:2; }
      .content { max-height:none; order:1; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Outlook ë©”ì¼ íƒ€ì„ë¼ì¸ & ìš”ì•½ ë·°ì–´</div>
      <div class="subtitle">.msg / .eml íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ì˜¬ë¦¬ë©´ íƒ€ì„ë¼ì¸Â·ìŠ¤ë ˆë“œÂ·ìš”ì•½ì„ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
    <div class="file-box">
      <span>ğŸ“ íŒŒì¼ ì„ íƒ (.msg, .eml)</span>
      <input id="fileInput" type="file" multiple accept=".msg,.eml,.txt" />
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="section-title">ê°œìš”</div>
      <div id="statsBox">
        ì•„ì§ ë©”ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
        â€¢ ì˜¤ë¥¸ìª½ ì˜ì—­ì˜ ë°•ìŠ¤ì— .msg / .eml íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜<br>
        â€¢ ìƒë‹¨ì˜ íŒŒì¼ ì„ íƒ ë²„íŠ¼ìœ¼ë¡œ ì—…ë¡œë“œí•´ ë³´ì„¸ìš”.
      </div>

      <div class="section-title" style="margin-top:10px;">ë³´ê¸° ëª¨ë“œ</div>
      <div class="toggle-group">
        <button class="toggle-btn active" id="btnTimeline">íƒ€ì„ë¼ì¸ ì „ì²´</button>
        <button class="toggle-btn" id="btnThread">ì„ íƒ ìŠ¤ë ˆë“œ</button>
      </div>

      <div class="section-title">ìŠ¤ë ˆë“œ ëª©ë¡</div>
      <div style="font-size:11px; color:#6b7280; margin-bottom:4px;">
        ì œëª©(ë‹µì¥/ì „ë‹¬ ì ‘ë‘ì–´ ì œê±°) ê¸°ì¤€ìœ¼ë¡œ ìë™ ê·¸ë£¹í™”í•©ë‹ˆë‹¤.
      </div>
      <div id="threadList" class="thread-list"></div>
    </aside>

    <section class="content">
      <div id="dropZone">
        ğŸ“¥ ì—¬ê¸°ë¡œ Outlook ë©”ì¼ íŒŒì¼(.msg / .eml)ì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ì„¸ìš”<br>
        <span style="font-size:11px; color:#9ca3af;">ì—¬ëŸ¬ ê°œ í•œ ë²ˆì— ë“œëí•´ë„ ë©ë‹ˆë‹¤.</span>
      </div>

      <div class="controls-row">
        <input id="searchInput" class="search-input" placeholder="ì œëª© / ë³´ë‚¸ ì‚¬ëŒ / ë°›ëŠ” ì‚¬ëŒ / ë³¸ë¬¸ìœ¼ë¡œ ê²€ìƒ‰..." />
        <button id="btnClearSearch" class="small-btn">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
      </div>

      <div id="viewInfo"></div>

      <div id="summaryContainer"></div>
      <div id="mailContainer"></div>
    </section>
  </main>

<script>
  // ==================== ì „ì—­ ìƒíƒœ ====================
  let allEmails = [];   // {subject, from, to, dateStr, dateObj, body, preview, threadKey, filename, sourceType}
  let threads   = [];   // {threadKey, subject, count, firstDate, lastDate, participants}
  let currentView = 'timeline'; // 'timeline' | 'thread'
  let currentThreadKey = null;

  const fileInput        = document.getElementById('fileInput');
  const dropZone         = document.getElementById('dropZone');
  const statsBox         = document.getElementById('statsBox');
  const threadListEl     = document.getElementById('threadList');
  const mailContainer    = document.getElementById('mailContainer');
  const summaryContainer = document.getElementById('summaryContainer');
  const viewInfo         = document.getElementById('viewInfo');
  const searchInput      = document.getElementById('searchInput');
  const btnClearSearch   = document.getElementById('btnClearSearch');
  const btnTimeline      = document.getElementById('btnTimeline');
  const btnThread        = document.getElementById('btnThread');

  // ==================== ì´ë²¤íŠ¸ ë°”ì¸ë”© ====================
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files.length) {
      handleFiles(Array.from(e.target.files));
    }
  });

  // ë“œë˜ê·¸ & ë“œë (í™”ë©´ ì „ì²´)
  window.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  window.addEventListener('dragleave', (e) => {
    // body ì˜ì—­ì„ ë²—ì–´ë‚  ë•Œë§Œ ì œê±°í•˜ê³  ì‹¶ìœ¼ë©´ ì¶”ê°€ ë¡œì§ í•„ìš”í•˜ì§€ë§Œ,
    // ê°„ë‹¨í•˜ê²Œ í•­ìƒ ì œê±°
    dropZone.classList.remove('dragover');
  });
  window.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files || []);
    if (files.length) {
      handleFiles(files);
    }
  });

  btnTimeline.addEventListener('click', () => {
    currentView = 'timeline';
    currentThreadKey = null;
    updateViewButtons();
    render();
  });
  btnThread.addEventListener('click', () => {
    currentView = 'thread';
    updateViewButtons();
    render();
  });

  btnClearSearch.addEventListener('click', () => {
    searchInput.value = '';
    render();
  });
  searchInput.addEventListener('input', () => render());

  function updateViewButtons() {
    btnTimeline.classList.toggle('active', currentView === 'timeline');
    btnThread.classList.toggle('active', currentView === 'thread');
  }

  // ==================== íŒŒì¼ ì²˜ë¦¬ ====================
  function handleFiles(files) {
    if (!files || !files.length) return;

    // ì´ˆê¸°í™”í•˜ì§€ ì•Šê³  ì¶”ê°€ ëª¨ë“œë¡œ í•  ìˆ˜ë„ ìˆì§€ë§Œ,
    // ì¼ë‹¨ ê°„ë‹¨í•˜ê²Œ: ìƒˆë¡œ ì˜¬ë¦¬ë©´ ì „ì²´ ë¦¬ì…‹
    allEmails = [];
    threads = [];
    currentThreadKey = null;
    mailContainer.innerHTML = '';
    summaryContainer.innerHTML = '';
    threadListEl.innerHTML = '';
    viewInfo.textContent = '';
    statsBox.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

    let remaining = files.length;

    files.forEach(file => {
      const name = file.name || '';
      const ext = name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      reader.onload = (ev) => {
        try {
          if (ext === 'msg') {
            const buffer = ev.target.result;
            const msgReader = new MSGReader(buffer);
            const data = msgReader.getFileData();
            const parsed = convertMsgToEmail(data, name);
            allEmails.push(parsed);
          } else {
            // eml / txt ë“± í…ìŠ¤íŠ¸ ë©”ì¼ í˜•ì‹
            const raw = ev.target.result;
            const parsed = parseEml(raw, name);
            allEmails.push(parsed);
          }
        } catch (err) {
          console.error('íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨:', name, err);
        } finally {
          remaining--;
          if (remaining === 0) {
            postProcessEmails();
          }
        }
      };

      if (ext === 'msg') {
        reader.readAsArrayBuffer(file);
      } else {
        reader.readAsText(file, 'utf-8');
      }
    });
  }

  // ==================== .msg â†’ ê³µí†µ ë©”ì¼ êµ¬ì¡° ====================
  function convertMsgToEmail(data, filename) {
    // data: MSGReader.getFileData() ê²°ê³¼
    let subject = data.subject || '(ì œëª© ì—†ìŒ)';

    let from = '';
    if (data.senderEmail || data.senderName) {
      if (data.senderEmail && data.senderName) {
        from = `${data.senderName} <${data.senderEmail}>`;
      } else {
        from = data.senderEmail || data.senderName;
      }
    }

    let to = '';
    if (Array.isArray(data.recipients) && data.recipients.length) {
      to = data.recipients.map(r => {
        if (r.email) {
          return r.name ? `${r.name} <${r.email}>` : r.email;
        }
        return r.name || '';
      }).join('; ');
    }

    // body / bodyHtml ì¤‘ ìš°ì„ ìˆœìœ„ ì„ íƒ
    let body = data.body || '';
    if (!body && data.bodyHtml) {
      body = stripHtmlTags(data.bodyHtml);
    }
    body = (body || '').trim();

    // Date íŒŒì‹±: headersì—ì„œ Date: ì°¾ê¸°
    let dateStr = '';
    let dateObj = new Date(NaN);
    if (data.headers) {
      const m = data.headers.match(/^Date:\s*(.+)$/mi);
      if (m) {
        dateStr = m[1].trim();
        const d = new Date(dateStr);
        if (!isNaN(d)) dateObj = d;
      }
    }
    // í˜¹ì‹œ messageDeliveryTime ê°™ì€ í•„ë“œê°€ ìˆìœ¼ë©´ ë³´ì¡°ë¡œ ì‚¬ìš©
    if (!dateStr && data.messageDeliveryTime) {
      dateStr = data.messageDeliveryTime;
      const d = new Date(dateStr);
      if (!isNaN(d)) dateObj = d;
    }

    const preview = makePreview(body);
    const threadKey = normalizeSubject(subject);

    return {
      sourceType: 'msg',
      filename: filename || '',
      subject,
      from,
      to,
      dateStr,
      dateObj,
      body,
      preview,
      threadKey
    };
  }

  function stripHtmlTags(html) {
    return String(html).replace(/<\/?[^>]+(>|$)/g, '');
  }

  // ==================== .eml â†’ ê³µí†µ ë©”ì¼ êµ¬ì¡° ====================
  function parseEml(raw, filename) {
    // í—¤ë” / ë³¸ë¬¸ ë¶„ë¦¬
    const parts = raw.split(/\r?\n\r?\n/);
    let headerText = parts[0] || '';
    let bodyText   = parts.slice(1).join('\n\n') || '';

    // í—¤ë” folding í•´ì œ
    headerText = headerText.replace(/(\r?\n)(\t| )+/g, ' ');

    function getHeader(name) {
      const re = new RegExp('^' + name + '\\s*:\\s*(.+)$', 'im');
      const m = headerText.match(re);
      return m ? m[1].trim() : '';
    }

    let subject = getHeader('Subject') || '(ì œëª© ì—†ìŒ)';
    const from  = getHeader('From');
    const to    = getHeader('To');
    const dateStr = getHeader('Date');
    const dateObj = dateStr ? new Date(dateStr) : new Date(NaN);

    const cleanBody = cleanBodyText(bodyText);
    const preview   = makePreview(cleanBody);
    const threadKey = normalizeSubject(subject);

    return {
      sourceType: 'eml',
      filename: filename || '',
      subject,
      from,
      to,
      dateStr,
      dateObj,
      body: cleanBody,
      preview,
      threadKey
    };
  }

  function cleanBodyText(body) {
    if (!body) return '';
    // ì¸ìš© ë¸”ë¡ ì œê±°(> ë¡œ ì‹œì‘í•˜ëŠ” ì¤„)
    body = body.replace(/^\s*>.*$/gm, '');
    // í”í•œ Original Message ë¨¸ë¦¬ ì œê±°
    body = body.replace(/^\s*On .* wrote:\s*$/gmi, '');
    body = body.replace(/^\s*-----Original Message-----.*$/gmi, '');
    return body.trim();
  }

  function makePreview(body) {
    if (!body) return '(ë³¸ë¬¸ ì—†ìŒ)';
    const lines = body.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const firstLines = lines.slice(0, 3).join(' ');
    return firstLines.length > 280 ? firstLines.slice(0, 280) + 'â€¦' : firstLines;
  }

  function normalizeSubject(subject) {
    if (!subject) return '(no-subject)';
    let s = subject.toLowerCase().trim();
    // re:, fw:, fwd:, ë‹µì¥:, ì „ë‹¬:, íšŒì‹ : ì œê±°
    s = s.replace(/^(re|fw|fwd|ë‹µì¥|ì „ë‹¬|íšŒì‹ )\s*:\s*/gi, '');
    // [ê³µì§€] ê°™ì€ Tag ì œê±°
    s = s.replace(/^\[.*?\]\s*/g, '');
    return s.trim() || '(no-subject)';
  }

  // ==================== í›„ì²˜ë¦¬: ìŠ¤ë ˆë“œ êµ¬ì„±, í†µê³„, ë Œë”ë§ ====================
  function postProcessEmails() {
    if (!allEmails.length) {
      statsBox.textContent = 'ë©”ì¼ì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. .msg / .eml í˜•ì‹ íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.';
      return;
    }

    // ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
    allEmails.sort((a, b) => {
      const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
      const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
      return t1 - t2;
    });

    buildThreads();
    updateStats();
    buildThreadList();

    currentView = 'timeline';
    currentThreadKey = null;
    updateViewButtons();
    render();
  }

  function buildThreads() {
    const map = new Map();

    allEmails.forEach(m => {
      const key = m.threadKey || '(no-subject)';
      if (!map.has(key)) {
        map.set(key, {
          threadKey: key,
          subject: m.subject,
          items: [],
          firstDate: m.dateObj,
          lastDate: m.dateObj,
          participants: new Set()
        });
      }
      const t = map.get(key);
      t.items.push(m);
      if (m.dateObj && (!t.firstDate || m.dateObj < t.firstDate)) t.firstDate = m.dateObj;
      if (m.dateObj && (!t.lastDate || m.dateObj > t.lastDate)) t.lastDate = m.dateObj;
      if (m.from) t.participants.add(m.from);
      if (m.to)   t.participants.add(m.to);
    });

    threads = Array.from(map.values()).map(t => ({
      threadKey: t.threadKey,
      subject: t.subject,
      count: t.items.length,
      firstDate: t.firstDate,
      lastDate: t.lastDate,
      participants: Array.from(t.participants)
    }));

    // ìµœê·¼ì— ì˜¤ê°„ ìŠ¤ë ˆë“œ ìš°ì„ 
    threads.sort((a, b) => {
      const t1 = a.lastDate && !isNaN(a.lastDate) ? a.lastDate.getTime() : 0;
      const t2 = b.lastDate && !isNaN(b.lastDate) ? b.lastDate.getTime() : 0;
      if (t2 !== t1) return t2 - t1;
      return b.count - a.count;
    });
  }

  function updateStats() {
    const total = allEmails.length;
    const threadCount = threads.length;
    const msgCount = allEmails.filter(m => m.sourceType === 'msg').length;
    const emlCount = allEmails.filter(m => m.sourceType === 'eml').length;

    const validDates = allEmails.filter(m => m.dateObj && !isNaN(m.dateObj));
    let rangeStr = 'ê¸°ê°„ ì •ë³´ ì—†ìŒ';
    if (validDates.length) {
      const first = validDates[0].dateObj;
      const last  = validDates[validDates.length - 1].dateObj;
      rangeStr = formatDateTime(first) + ' ~ ' + formatDateTime(last);
    }

    statsBox.innerHTML = `
      ğŸ“¨ ì´ ë©”ì¼: <b>${total}</b>ê°œ<br>
      â€¢ MSG: ${msgCount}ê°œ / EML: ${emlCount}ê°œ<br>
      ğŸ§µ ìŠ¤ë ˆë“œ: <b>${threadCount}</b>ê°œ<br>
      â± ê¸°ê°„: ${rangeStr}
    `;
  }

  function buildThreadList() {
    threadListEl.innerHTML = '';
    threads.forEach(t => {
      const div = document.createElement('div');
      div.className = 'thread-item';
      if (t.threadKey === currentThreadKey) div.classList.add('active');

      const lastStr = t.lastDate ? formatDateTimeShort(t.lastDate) : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
      div.innerHTML = `
        <div class="thread-subject" title="${escapeHtml(t.subject)}">${escapeHtml(t.subject)}</div>
        <div class="thread-meta">${t.count}í†µ Â· ë§ˆì§€ë§‰: ${lastStr}</div>
      `;

      div.addEventListener('click', () => {
        currentView = 'thread';
        currentThreadKey = t.threadKey;
        updateViewButtons();
        buildThreadList();
        render();
      });

      threadListEl.appendChild(div);
    });
  }

  function render() {
    if (!allEmails.length) {
      mailContainer.innerHTML = '<div class="empty-state">í‘œì‹œí•  ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      summaryContainer.innerHTML = '';
      viewInfo.textContent = '';
      return;
    }

    let mailsToShow;
    if (currentView === 'thread' && currentThreadKey) {
      mailsToShow = allEmails.filter(m => m.threadKey === currentThreadKey);
    } else {
      mailsToShow = [...allEmails];
    }

    const keyword = (searchInput.value || '').toLowerCase().trim();
    if (keyword) {
      mailsToShow = mailsToShow.filter(m => {
        const text = (m.subject || '') + ' ' + (m.from || '') + ' ' + (m.to || '') + ' ' + (m.body || '');
        return text.toLowerCase().includes(keyword);
      });
    }

    // ì‹œê°„ ìˆœìœ¼ë¡œ ì¬ì •ë ¬
    mailsToShow.sort((a, b) => {
      const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
      const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
      return t1 - t2;
    });

    // ë·° ì •ë³´
    if (currentView === 'timeline') {
      viewInfo.textContent = `ì „ì²´ íƒ€ì„ë¼ì¸ ë³´ê¸° Â· í‘œì‹œ ì¤‘: ${mailsToShow.length}í†µ`;
    } else {
      const th = threads.find(t => t.threadKey === currentThreadKey);
      const subj = th ? th.subject : '(ì œëª© ì—†ìŒ)';
      viewInfo.textContent = `ìŠ¤ë ˆë“œ ë³´ê¸° Â· "${subj}" Â· í‘œì‹œ ì¤‘: ${mailsToShow.length}í†µ`;
    }

    // ìŠ¤ë ˆë“œ ìš”ì•½
    summaryContainer.innerHTML = '';
    if (currentView === 'thread' && currentThreadKey && mailsToShow.length) {
      const summaryText = buildThreadSummary(mailsToShow);
      const div = document.createElement('div');
      div.className = 'summary-card';
      div.innerHTML = `
        <div class="summary-title">ğŸ§¾ ìŠ¤ë ˆë“œ ìë™ ìš”ì•½ (ê°„ë‹¨ ìš”ì•½)</div>
        ${escapeHtml(summaryText)}
        <div class="summary-hint">
          â€» ì‹¤ì œ AI ìš”ì•½ì´ ì•„ë‹ˆë¼, ê° ë©”ì¼ ì•ë¶€ë¶„ì„ ëª¨ì•„ì„œ íë¦„ë§Œ ê°„ë‹¨íˆ ë³´ì—¬ì¤ë‹ˆë‹¤.
        </div>
      `;
      summaryContainer.appendChild(div);
    }

    // ë©”ì¼ ì¹´ë“œ ë Œë”ë§
    mailContainer.innerHTML = '';
    if (!mailsToShow.length) {
      mailContainer.innerHTML = `
        <div class="empty-state">
          ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>
          ê²€ìƒ‰ì–´ë¥¼ ì§€ìš°ê±°ë‚˜ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¥¼ ì„ íƒí•´ ë³´ì„¸ìš”.
        </div>`;
      return;
    }

    mailsToShow.forEach((m, idx) => {
      const card = document.createElement('div');
      card.className = 'mail-card';

      const dtStr = m.dateObj && !isNaN(m.dateObj) ? formatDateTime(m.dateObj) : (m.dateStr || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ');
      const from = m.from || '(ë³´ë‚¸ ì‚¬ëŒ ì—†ìŒ)';
      const to   = m.to   || '(ë°›ëŠ” ì‚¬ëŒ ì—†ìŒ)';
      const threadSubject = findThreadSubject(m.threadKey);

      card.innerHTML = `
        <div class="mail-header">
          <div>
            <div class="mail-subject">${escapeHtml(m.subject)}</div>
            <div class="mail-meta">
              From: ${escapeHtml(from)}<br>
              To: ${escapeHtml(to)}
            </div>
          </div>
          <div class="mail-date">${escapeHtml(dtStr)}</div>
        </div>
        <div class="mail-body-preview">
          ${escapeHtml(m.preview)}
          <span class="clickable" data-id="toggle-${idx}">ë”ë³´ê¸°</span>
        </div>
        <div class="mail-body-full" id="full-${idx}">
${escapeHtml(m.body)}
        </div>
        <div class="mail-tags">
          <span class="pill">${escapeHtml(threadSubject)}</span>
          <span class="pill">íŒŒì¼: ${escapeHtml(m.filename || '')}</span>
          <span class="pill">${m.sourceType === 'msg' ? 'MSG' : 'EML'}</span>
        </div>
      `;

      const toggle = card.querySelector(`[data-id="toggle-${idx}"]`);
      const full   = card.querySelector(`#full-${idx}`);
      toggle.addEventListener('click', () => {
        const open = full.style.display === 'block';
        full.style.display = open ? 'none' : 'block';
        toggle.textContent = open ? 'ë”ë³´ê¸°' : 'ì ‘ê¸°';
      });

      mailContainer.appendChild(card);
    });
  }

  function buildThreadSummary(mails) {
    if (!mails.length) return '';
    const first = mails[0];
    const last  = mails[mails.length - 1];
    let summary = '';

    summary += `â€¢ ëŒ€í™” ê¸°ê°„: ${formatDateTime(first.dateObj)} ~ ${formatDateTime(last.dateObj)}\n`;
    summary += `â€¢ ë©”ì¼ ìˆ˜: ${mails.length}í†µ\n`;

    const participants = new Set();
    mails.forEach(m => {
      if (m.from) participants.add(m.from);
      if (m.to)   participants.add(m.to);
    });
    summary += `â€¢ ì£¼ìš” ì°¸ì—¬ì: ${Array.from(participants).join(', ') || 'ì •ë³´ ì—†ìŒ'}\n\n`;
    summary += 'â€¢ íë¦„:\n';

    mails.forEach((m, i) => {
      const dt = m.dateObj && !isNaN(m.dateObj) ? formatDateTimeShort(m.dateObj) : (m.dateStr || '');
      const pv = (m.preview || '').replace(/\s+/g, ' ');
      summary += `  - [${i+1} / ${dt}] ${pv}\n`;
    });
    return summary.trim();
  }

  function findThreadSubject(threadKey) {
    const t = threads.find(x => x.threadKey === threadKey);
    return t ? t.subject : '(ì œëª© ì—†ìŒ)';
  }

  function formatDateTime(d) {
    if (!(d instanceof Date) || isNaN(d)) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
    const yyyy = d.getFullYear();
    const mm   = String(d.getMonth()+1).padStart(2, '0');
    const dd   = String(d.getDate()).padStart(2, '0');
    const hh   = String(d.getHours()).padStart(2, '0');
    const mi   = String(d.getMinutes()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }
  function formatDateTimeShort(d) {
    if (!(d instanceof Date) || isNaN(d)) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
    const mm = String(d.getMonth()+1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mi = String(d.getMinutes()).padStart(2, '0');
    return `${mm}-${dd} ${hh}:${mi}`;
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
</script>
</body>
</html>

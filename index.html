<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸° (GitHub ì €ì¥)</title>

  <!-- âœ… ì•ˆì • ë²„ì „ MSG Reader (DataStream í¬í•¨) -->
  <!-- ìˆœì„œ ì¤‘ìš”: DataStream ë¨¼ì €, ê·¸ ë‹¤ìŒ MsgReader -->
  <script src="https://etech-symantec.github.io/case/lib/DataStream.js"></script>
  <script src="https://etech-symantec.github.io/case/lib/MsgReader.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(90deg,#1d4ed8,#0f766e);
      color:white;
      padding:12px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .title { font-size:18px; font-weight:600; }
    .subtitle { font-size:12px; opacity:.9; }

    .file-box {
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,0.2);
      padding:6px 12px; border-radius:9999px;
      font-size:11px;
    }
    .file-box input[type="file"] { font-size:11px; }

    main { display:flex; gap:16px; padding:16px; }

    .sidebar {
      width:260px; padding:12px;
      background:white; border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      height:calc(100vh - 70px);
      overflow:auto;
      font-size:12px;
    }
    .content {
      flex:1; height:calc(100vh - 70px);
      overflow:auto;
    }

    .section-title { font-weight:600; margin:6px 0; font-size:13px; }

    .gh-config label {
      display:block;
      font-size:11px;
      margin-top:4px;
    }
    .gh-config input {
      width:100%;
      padding:4px 6px;
      margin-top:2px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:11px;
    }

    .small-btn {
      padding:4px 8px;
      background:white;
      border-radius:8px;
      border:1px solid #d1d5db;
      cursor:pointer;
      font-size:11px;
    }
    .small-btn:hover { background:#f3f4f6; }

    .case-item {
      padding:6px;
      border-radius:8px;
      cursor:pointer;
      margin-bottom:4px;
    }
    .case-item:hover { background:#e5e7eb; }
    .case-item.active { background:#0f766e; color:white; }

    .stats-box {
      background:#eff6ff;
      padding:10px;
      border-radius:8px;
      margin-bottom:10px;
      line-height:1.5;
    }

    .toggle-group {
      display:flex; gap:4px; margin:6px 0 10px;
    }
    .toggle-btn {
      flex:1; padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:999px;
      background:white;
      cursor:pointer;
      font-size:12px;
    }
    .toggle-btn.active {
      background:#1d4ed8; color:white;
      border-color:#1d4ed8;
    }

    .thread-item {
      padding:6px;
      border-radius:8px;
      cursor:pointer;
      margin-bottom:4px;
      font-size:12px;
    }
    .thread-item:hover { background:#f3f4f6; }
    .thread-item.active { background:#1d4ed8; color:white; }

    #dropZone {
      border:2px dashed #9ca3af;
      background:white;
      padding:30px;
      border-radius:12px;
      text-align:center;
      font-size:13px;
      margin-bottom:12px;
      color:#6b7280;
      transition:.2s;
    }
    #dropZone.dragover {
      border-color:#2563eb;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .controls-row {
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .search-input {
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
    }

    .summary-card {
      background:#fefce8;
      border:1px solid #facc15;
      padding:10px;
      border-radius:12px;
      margin-bottom:12px;
      font-size:12px;
      white-space:pre-wrap;
    }

    .mail-card {
      background:white;
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
      border-left:3px solid #e5e7eb;
      font-size:12px;
    }
    .mail-header {
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      gap:8px;
    }
    .mail-subject { font-weight:600; margin-bottom:3px; }
    .mail-meta { color:#6b7280; font-size:11px; }
    .mail-date { font-size:11px; color:#374151; white-space:nowrap; }

    .mail-body-preview {
      margin-top:6px;
      white-space:pre-wrap;
      color:#374151;
    }
    .mail-body-full {
      display:none;
      margin-top:6px;
      border-top:1px dashed #d1d5db;
      padding-top:6px;
      white-space:pre-wrap;
    }
    .clickable {
      color:#2563eb;
      cursor:pointer;
      text-decoration:underline dotted;
    }

    .pill {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      margin-right:4px;
      font-size:11px;
      margin-top:4px;
    }

    @media (max-width:900px) {
      main { flex-direction:column; }
      .sidebar { width:100%; height:auto; }
      .content { height:auto; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸°</div>
    <div class="subtitle">.msg / .eml â†’ ì¼€ì´ìŠ¤ë³„ íƒ€ì„ë¼ì¸ & ìš”ì•½ Â· GitHub JSON ì €ì¥</div>
  </div>
  <div class="file-box">
    <span>ğŸ“ íŒŒì¼ ì„ íƒ (.msg / .eml)</span>
    <input id="fileInput" type="file" multiple accept=".msg,.eml" />
  </div>
</header>

<main>
  <aside class="sidebar">
    <!-- GitHub ì„¤ì • (í† í°ë§Œ) -->
    <div class="section-title">GitHub ì„¤ì •</div>
    <div class="gh-config">
      <label>ê°œì¸ ì•¡ì„¸ìŠ¤ í† í° (PAT)</label>
      <input id="ghToken" type="password" placeholder="github_pat_...">
      <button id="btnSaveGhConfig" class="small-btn" style="width:100%; margin-top:6px;">í† í° ì €ì¥</button>
      <button id="btnLoadCasesGh" class="small-btn" style="width:100%; margin-top:4px;">ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <div style="font-size:11px; color:#6b7280; margin-top:4px;">
        * í† í°ì€ ì´ ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.<br>
        * ê³µê°œ RepoëŠ” ì½ê¸°ë§Œ í•  ë• í† í° ì—†ì´ë„ ê°€ëŠ¥í•˜ì§€ë§Œ,<br>
        &nbsp;&nbsp;ì €ì¥ì€ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.
      </div>
    </div>

    <hr style="margin:10px 0;">

    <!-- ì¼€ì´ìŠ¤ ê´€ë¦¬ -->
    <div class="section-title">ì¼€ì´ìŠ¤ ê´€ë¦¬</div>
    <button id="addCaseBtn" class="small-btn" style="width:100%;">â• ì¼€ì´ìŠ¤ ì¶”ê°€í•˜ê¸°</button>
    <div id="caseList" style="margin-top:6px;"></div>

    <hr style="margin:10px 0;">

    <!-- ê°œìš” / ë³´ê¸° ëª¨ë“œ / ìŠ¤ë ˆë“œ -->
    <div class="section-title">ê°œìš”</div>
    <div id="statsBox" class="stats-box">
      GitHub í† í° ì…ë ¥ í›„, <b>ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
    </div>

    <div class="section-title">ë³´ê¸° ëª¨ë“œ</div>
    <div class="toggle-group">
      <button id="btnTimeline" class="toggle-btn active">íƒ€ì„ë¼ì¸ ì „ì²´</button>
      <button id="btnThread" class="toggle-btn">ìŠ¤ë ˆë“œ ë³´ê¸°</button>
    </div>

    <div class="section-title">ìŠ¤ë ˆë“œ ëª©ë¡</div>
    <div id="threadList"></div>
  </aside>

  <section class="content">
    <div id="dropZone">
      ğŸ“¥ ì´ê³³ì— .msg / .eml íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ì„¸ìš”<br>
      <span style="font-size:11px; color:#9ca3af;">í˜„ì¬ ì„ íƒëœ ì¼€ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
    </div>

    <div class="controls-row">
      <input id="searchInput" class="search-input" placeholder="ì œëª© / ë³¸ë¬¸ / ë³´ë‚¸ ì‚¬ëŒ ê²€ìƒ‰" />
      <button id="btnClearSearch" class="small-btn">ì´ˆê¸°í™”</button>
    </div>

    <div id="viewInfo" style="font-size:11px; margin-bottom:6px;"></div>

    <div id="summaryContainer"></div>
    <div id="mailContainer"></div>
  </section>
</main>

<script>
  // ===================== GitHub ê¸°ë³¸ ì„¤ì • (ê³ ì •ê°’) =====================
  let githubConfig = {
    username: 'etech-symantec',
    repo: 'case',
    branch: 'main',
    token: ''
  };

  let casesMeta = [];      // [{id, name}]
  let caseData  = {};      // id -> {id, name, emails: []}
  let currentCaseId = null;

  // ë·°ì–´ ìƒíƒœ
  let allEmails = [];
  let threads   = [];
  let currentView = 'timeline'; // 'timeline' | 'thread'
  let currentThreadKey = null;

  // ===================== ìœ í‹¸: Base64 / GitHub =====================
  function encodeBase64Utf8(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function decodeBase64Utf8(b64) {
    return decodeURIComponent(escape(atob(b64)));
  }
  function githubHeaders() {
    const h = { 'Accept': 'application/vnd.github+json' };
    if (githubConfig.token) {
      h['Authorization'] = 'Bearer ' + githubConfig.token;
    }
    return h;
  }
  function githubContentUrl(path) {
    return `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${path}`;
  }
  function ensureRepoConfigured() {
    if (!githubConfig.username || !githubConfig.repo) {
      alert('GitHub ì €ì¥ì†Œ ì„¤ì •ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
      return false;
    }
    if (!githubConfig.branch) githubConfig.branch = 'main';
    return true;
  }
  function ensureRepoAndTokenConfigured() {
    if (!ensureRepoConfigured()) return false;
    if (!githubConfig.token) {
      alert('GitHubì— ì €ì¥í•˜ë ¤ë©´ í† í°(PAT)ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return false;
    }
    return true;
  }

  async function githubGetJSON(path) {
    if (!ensureRepoConfigured()) throw new Error('GitHub Repo ì„¤ì • ëˆ„ë½');
    const url = githubContentUrl(path) + `?ref=${githubConfig.branch || 'main'}`;
    const res = await fetch(url, { headers: githubHeaders() });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error('GitHub GET ì‹¤íŒ¨: ' + res.status);
    const data = await res.json();
    const decoded = decodeBase64Utf8(data.content);
    return JSON.parse(decoded);
  }

  async function githubPutJSON(path, obj, message) {
    if (!ensureRepoAndTokenConfigured()) throw new Error('GitHub ì„¤ì • ëˆ„ë½');
    const url = githubContentUrl(path);
    let sha = null;

    // ê¸°ì¡´ íŒŒì¼ sha ì¡°íšŒ
    const getRes = await fetch(url, { headers: githubHeaders() });
    if (getRes.status === 200) {
      const existing = await getRes.json();
      sha = existing.sha;
    } else if (getRes.status !== 404) {
      throw new Error('ê¸°ì¡´ íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨: ' + getRes.status);
    }

    const body = {
      message: message || 'update via outlook-case-github-viewer',
      content: encodeBase64Utf8(JSON.stringify(obj, null, 2)),
      branch: githubConfig.branch || 'main'
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(url, {
      method: 'PUT',
      headers: { ...githubHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!putRes.ok) {
      const errText = await putRes.text();
      throw new Error('GitHub ì—…ë¡œë“œ ì‹¤íŒ¨: ' + putRes.status + ' ' + errText);
    }
    return await putRes.json();
  }

  // ===================== GitHub ì„¤ì • ë¡œë“œ/ì €ì¥ =====================
  function loadGithubConfigFromLocalStorage() {
    const raw = localStorage.getItem('githubConfig_v2');
    if (raw) {
      try {
        const cfg = JSON.parse(raw);
        githubConfig.token = cfg.token || '';
      } catch(e) {
        console.error('githubConfig íŒŒì‹± ì‹¤íŒ¨:', e);
      }
    }
    ghTokenInput.value = githubConfig.token;
  }

  function saveGithubConfigToLocalStorage() {
    githubConfig.token = ghTokenInput.value.trim();
    localStorage.setItem('githubConfig_v2', JSON.stringify({ token: githubConfig.token }));
    alert('GitHub í† í°ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  }

  async function refreshCasesFromGithub() {
    try {
      const indexJson = await githubGetJSON('cases/index.json');
      if (!indexJson) {
        casesMeta = [];
        caseData = {};
        currentCaseId = null;
        renderCaseList();
        statsBox.innerHTML = 'GitHubì— ì•„ì§ cases/index.jsonì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì €ì¥í•˜ë©´ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.';
        mailContainer.innerHTML = '';
        summaryContainer.innerHTML = '';
        viewInfo.textContent = '';
        return;
      }
      casesMeta = indexJson;
      caseData = {};
      currentCaseId = null;
      renderCaseList();
      statsBox.innerHTML = 'GitHubì—ì„œ ì¼€ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.<br>ì¢Œì¸¡ì—ì„œ ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì„ ë¡œë”©í•©ë‹ˆë‹¤.';
      mailContainer.innerHTML = '';
      summaryContainer.innerHTML = '';
      viewInfo.textContent = '';
    } catch (e) {
      alert('ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message);
    }
  }

  // ===================== ì¼€ì´ìŠ¤ & ë·°ì–´ ê´€ë ¨ =====================
  function renderCaseList() {
    caseListEl.innerHTML = '';
    casesMeta.forEach(c => {
      const div = document.createElement('div');
      div.className = 'case-item' + (c.id === currentCaseId ? ' active' : '');
      div.textContent = c.name;
      div.addEventListener('click', () => {
        currentCaseId = c.id;
        renderCaseList();
        loadCaseIntoViewer(c.id);
      });
      caseListEl.appendChild(div);
    });
  }

  async function loadCaseIntoViewer(caseId) {
    if (caseData[caseId]) {
      allEmails = caseData[caseId].emails || [];
      currentView = 'timeline';
      currentThreadKey = null;
      postProcessEmails();
      return;
    }
    try {
      const obj = await githubGetJSON(`cases/${caseId}.json`);
      if (!obj) {
        alert('í•´ë‹¹ ì¼€ì´ìŠ¤ ë°ì´í„° íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      caseData[caseId] = {
        id: obj.id,
        name: obj.name,
        emails: obj.emails || []
      };
      allEmails = caseData[caseId].emails;
      currentView = 'timeline';
      currentThreadKey = null;
      postProcessEmails();
    } catch (e) {
      alert('ì¼€ì´ìŠ¤ ë¡œë”© ì‹¤íŒ¨: ' + e.message);
    }
  }

  async function saveCurrentCaseToGithub(showAlert = true) {
    if (!currentCaseId) return;
    const meta = casesMeta.find(c => c.id === currentCaseId);
    if (!meta) return;
    if (!ensureRepoAndTokenConfigured()) return;

    const obj = {
      id: currentCaseId,
      name: meta.name,
      emails: allEmails
    };
    caseData[currentCaseId] = obj;

    await githubPutJSON(`cases/${currentCaseId}.json`, obj,
      `Update case ${meta.name} (${currentCaseId})`);

    await githubPutJSON('cases/index.json', casesMeta,
      'Update cases index');

    if (showAlert) alert('í˜„ì¬ ì¼€ì´ìŠ¤ë¥¼ GitHubì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  }

  // ===================== ë©”ì¼ íŒŒì‹± (MSG / EML) =====================
  function normalizeSubject(subject) {
    if (!subject) return '(no-subject)';
    let s = subject.toLowerCase().trim();
    s = s.replace(/^(re|fw|fwd|ë‹µì¥|ì „ë‹¬|íšŒì‹ )\s*:\s*/gi, '');
    s = s.replace(/^\[.*?\]\s*/g, '');
    return s.trim() || '(no-subject)';
  }

  function makePreview(body) {
    if (!body) return '(ë³¸ë¬¸ ì—†ìŒ)';
    const lines = String(body).split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const first = lines.slice(0,3).join(' ');
    return first.length > 260 ? first.slice(0,260) + 'â€¦' : first;
  }

  function convertMsgToEmail(data, filename) {
    let subject = data.subject || '(ì œëª© ì—†ìŒ)';

    const fromName  = data.senderName || (data.sender && data.sender.name) || '';
    const fromEmail = data.senderEmail || (data.sender && data.sender.email) || '';
    let from = '';
    if (fromName || fromEmail) {
      from = fromName && fromEmail ? `${fromName} <${fromEmail}>` : (fromEmail || fromName);
    }

    let to = '';
    if (Array.isArray(data.recipients) && data.recipients.length) {
      to = data.recipients.map(r => {
        const n = r.name || '';
        const e = r.email || '';
        if (n && e) return `${n} <${e}>`;
        return e || n;
      }).join('; ');
    }

    let body = data.body || data.bodyText || '';
    if (!body && data.bodyHtml) {
      body = data.bodyHtml.replace(/<\/?[^>]+(>|$)/g, '');
    }
    body = (body || '').trim();

    // ë‚ ì§œ ì¶”ì¶œ
    let dateStr = '';
    let dateObj = new Date(NaN);

    if (data.headers && typeof data.headers === 'string') {
      const m = data.headers.match(/^Date:\s*(.+)$/mi);
      if (m) {
        dateStr = m[1].trim();
        const d = new Date(dateStr);
        if (!isNaN(d)) dateObj = d;
      }
    }

    if (!dateStr && data.creationTime) {
      dateStr = data.creationTime;
      const d = new Date(dateStr);
      if (!isNaN(d)) dateObj = d;
    }

    const preview   = makePreview(body);
    const threadKey = normalizeSubject(subject);

    return {
      sourceType: 'msg',
      filename: filename || '',
      subject,
      from,
      to,
      dateStr,
      dateObj,
      body,
      preview,
      threadKey
    };
  }

  function parseEml(raw, filename) {
    const parts = raw.split(/\r?\n\r?\n/);
    let headerText = parts[0] || '';
    let bodyText   = parts.slice(1).join('\n\n') || '';

    // header folding í•´ì œ
    headerText = headerText.replace(/(\r?\n)(\t| )+/g, ' ');

    function getHeader(name) {
      const re = new RegExp('^' + name + '\\s*:\\s*(.+)$', 'im');
      const m = headerText.match(re);
      return m ? m[1].trim() : '';
    }

    let subject = getHeader('Subject') || '(ì œëª© ì—†ìŒ)';
    const from  = getHeader('From');
    const to    = getHeader('To');
    const dateStr = getHeader('Date');
    const dateObj = dateStr ? new Date(dateStr) : new Date(NaN);

    // ì¸ìš© ë¸”ë¡ ê°„ë‹¨ ì œê±°
    let body = bodyText.replace(/^\s*>.*$/gm, '').trim();

    const preview   = makePreview(body);
    const threadKey = normalizeSubject(subject);

    return {
      sourceType: 'eml',
      filename: filename || '',
      subject,
      from,
      to,
      dateStr,
      dateObj,
      body,
      preview,
      threadKey
    };
  }

  // ===================== í›„ì²˜ë¦¬ & ë Œë”ë§ =====================
  function buildThreads() {
    const map = new Map();
    allEmails.forEach(m => {
      const key = m.threadKey || '(no-subject)';
      if (!map.has(key)) {
        map.set(key, { threadKey: key, subject: m.subject, items: [] });
      }
      map.get(key).items.push(m);
    });
    threads = Array.from(map.values());
  }

  function updateStats() {
    const total = allEmails.length;
    const threadCount = threads.length;
    statsBox.innerHTML = `ë©”ì¼ ìˆ˜: <b>${total}</b>ê°œ<br>ìŠ¤ë ˆë“œ: <b>${threadCount}</b>ê°œ`;
  }

  function renderThreadList() {
    threadListEl.innerHTML = '';
    threads.forEach(t => {
      const div = document.createElement('div');
      div.className = 'thread-item' + (t.threadKey === currentThreadKey ? ' active' : '');
      div.textContent = `${t.subject} (${t.items.length})`;
      div.addEventListener('click', () => {
        currentThreadKey = t.threadKey;
        currentView = 'thread';
        render();
        renderThreadList();
      });
      threadListEl.appendChild(div);
    });
  }

  function formatDateTime(d) {
    if (!(d instanceof Date) || isNaN(d)) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
    const y  = d.getFullYear();
    const m  = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const h  = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${y}-${m}-${dd} ${h}:${mi}`;
  }

  function buildThreadSummary(list) {
    if (!list.length) return '';
    const first = list[0];
    const last  = list[list.length-1];
    let s = '';
    s += `ê¸°ê°„: ${formatDateTime(first.dateObj)} ~ ${formatDateTime(last.dateObj)}\n`;
    s += `ë©”ì¼ ìˆ˜: ${list.length}í†µ\n\n`;
    s += 'íë¦„:\n';
    list.forEach((m,i) => {
      s += `  [${i+1}] ${m.preview}\n`;
    });
    return s;
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  function postProcessEmails() {
    if (!allEmails.length) {
      statsBox.textContent = 'ë©”ì¼ ì—†ìŒ';
      mailContainer.innerHTML = '';
      summaryContainer.innerHTML = '';
      viewInfo.textContent = '';
      return;
    }
    allEmails.sort((a,b) => {
      const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
      const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
      return t1 - t2;
    });
    buildThreads();
    updateStats();
    renderThreadList();
    render();
  }

  function render() {
    let list;
    if (currentView === 'thread' && currentThreadKey) {
      const th = threads.find(x => x.threadKey === currentThreadKey);
      list = th ? [...th.items] : [];
    } else {
      list = [...allEmails];
    }

    const kw = (searchInput.value || '').toLowerCase().trim();
    if (kw) {
      list = list.filter(m => (m.subject + m.body + m.from + m.to).toLowerCase().includes(kw));
    }

    list.sort((a,b) => {
      const t1 = a.dateObj && !isNaN(a.dateObj) ? a.dateObj.getTime() : 0;
      const t2 = b.dateObj && !isNaN(b.dateObj) ? b.dateObj.getTime() : 0;
      return t1 - t2;
    });

    if (currentView === 'timeline') {
      viewInfo.textContent = `ì „ì²´ íƒ€ì„ë¼ì¸ Â· ${list.length}í†µ`;
    } else {
      viewInfo.textContent = `ìŠ¤ë ˆë“œ ë³´ê¸° Â· ${list.length}í†µ`;
    }

    summaryContainer.innerHTML = '';
    if (currentView === 'thread' && list.length) {
      const sum = buildThreadSummary(list);
      summaryContainer.innerHTML = `<div class="summary-card"><b>ìŠ¤ë ˆë“œ ìš”ì•½</b>\n${escapeHtml(sum)}</div>`;
    }

    mailContainer.innerHTML = '';
    list.forEach((m, idx) => {
      const card = document.createElement('div');
      card.className = 'mail-card';
      card.innerHTML = `
        <div class="mail-header">
          <div>
            <div class="mail-subject">${escapeHtml(m.subject)}</div>
            <div class="mail-meta">
              From: ${escapeHtml(m.from)}<br>
              To: ${escapeHtml(m.to)}
            </div>
          </div>
          <div class="mail-date">${escapeHtml(formatDateTime(m.dateObj))}</div>
        </div>
        <div class="mail-body-preview">
          ${escapeHtml(m.preview)}
          <span class="clickable" data-id="toggle-${idx}">ë”ë³´ê¸°</span>
        </div>
        <div class="mail-body-full" id="full-${idx}">
${escapeHtml(m.body)}
        </div>
        <div class="mail-tags">
          <span class="pill">${escapeHtml(m.filename)}</span>
          <span class="pill">${m.sourceType.toUpperCase()}</span>
        </div>
      `;
      const toggle = card.querySelector(`[data-id="toggle-${idx}"]`);
      const full   = card.querySelector(`#full-${idx}`);
      toggle.addEventListener('click', () => {
        const show = full.style.display === 'block';
        full.style.display = show ? 'none' : 'block';
        toggle.textContent = show ? 'ë”ë³´ê¸°' : 'ì ‘ê¸°';
      });
      mailContainer.appendChild(card);
    });
  }

  // ===================== íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ =====================
  function handleFiles(files) {
    if (!currentCaseId) {
      alert('ë¨¼ì € ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•˜ì„¸ìš”.');
      return;
    }

    // ê¸°ì¡´ ì¼€ì´ìŠ¤ ë©”ì¼ ìœ ì§€ + ì¶”ê°€
    if (caseData[currentCaseId]?.emails) {
      allEmails = [...caseData[currentCaseId].emails];
    } else {
      allEmails = [];
    }

    threads = [];
    currentThreadKey = null;
    statsBox.textContent = 'íŒŒì¼ ì½ëŠ” ì¤‘â€¦';

    if (!files || !files.length) return;

    let remaining = files.length;

    files.forEach(file => {
      const name = file.name || '';
      const ext  = name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      reader.onload = ev => {
        try {
          if (ext === 'msg') {
            if (typeof MsgReader === 'undefined') {
              console.error('MsgReader ì „ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
            } else {
              const buffer = ev.target.result;
              const mr = new MsgReader(buffer);
              const data = mr.getFileData();
              allEmails.push(convertMsgToEmail(data, name));
            }
          } else {
            const raw = ev.target.result;
            allEmails.push(parseEml(raw, name));
          }
        } catch(e) {
          console.error('íŒŒì‹± ì‹¤íŒ¨:', name, e);
        } finally {
          remaining--;
          if (remaining === 0) {
            // ë©”ëª¨ë¦¬ êµ¬ì¡°ì—ë„ ë°˜ì˜
            if (!caseData[currentCaseId]) {
              const meta = casesMeta.find(c => c.id === currentCaseId);
              caseData[currentCaseId] = { id: currentCaseId, name: meta ? meta.name : '', emails: [] };
            }
            caseData[currentCaseId].emails = allEmails;
            postProcessEmails();
            // GitHub ìë™ ì €ì¥
            saveCurrentCaseToGithub(false).catch(err => {
              console.error('GitHub ì €ì¥ ì˜¤ë¥˜:', err);
              alert('GitHub ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            });
          }
        }
      };

      if (ext === 'msg') reader.readAsArrayBuffer(file);
      else reader.readAsText(file, 'utf-8');
    });
  }

  // ===================== DOM ì—˜ë¦¬ë¨¼íŠ¸ & ì´ë²¤íŠ¸ ë°”ì¸ë”© =====================
  const ghTokenInput     = document.getElementById('ghToken');
  const btnSaveGhConfig  = document.getElementById('btnSaveGhConfig');
  const btnLoadCasesGh   = document.getElementById('btnLoadCasesGh');

  const addCaseBtn       = document.getElementById('addCaseBtn');
  const caseListEl       = document.getElementById('caseList');
  const fileInput        = document.getElementById('fileInput');
  const dropZone         = document.getElementById('dropZone');
  const statsBox         = document.getElementById('statsBox');
  const threadListEl     = document.getElementById('threadList');
  const mailContainer    = document.getElementById('mailContainer');
  const summaryContainer = document.getElementById('summaryContainer');
  const viewInfo         = document.getElementById('viewInfo');
  const searchInput      = document.getElementById('searchInput');
  const btnClearSearch   = document.getElementById('btnClearSearch');
  const btnTimeline      = document.getElementById('btnTimeline');
  const btnThread        = document.getElementById('btnThread');

  btnSaveGhConfig.addEventListener('click', saveGithubConfigToLocalStorage);
  btnLoadCasesGh.addEventListener('click', refreshCasesFromGithub);

  addCaseBtn.addEventListener('click', () => {
    if (!ensureRepoConfigured()) return;
    const name = prompt('ì¼€ì´ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (!name) return;
    const id = 'case_' + Date.now();
    casesMeta.push({ id, name });
    currentCaseId = id;
    caseData[id] = { id, name, emails: [] };
    renderCaseList();
    statsBox.innerHTML = 'ìƒˆ ì¼€ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë©”ì¼ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ GitHubì— ì €ì¥ë©ë‹ˆë‹¤.';
    fileInput.click();
  });

  fileInput.addEventListener('change', e => {
    const files = Array.from(e.target.files || []);
    handleFiles(files);
  });

  window.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  window.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });
  window.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files || []);
    handleFiles(files);
  });

  btnTimeline.addEventListener('click', () => {
    currentView = 'timeline';
    currentThreadKey = null;
    btnTimeline.classList.add('active');
    btnThread.classList.remove('active');
    render();
  });
  btnThread.addEventListener('click', () => {
    currentView = 'thread';
    btnThread.classList.add('active');
    btnTimeline.classList.remove('active');
    render();
  });

  searchInput.addEventListener('input', render);
  btnClearSearch.addEventListener('click', () => {
    searchInput.value = '';
    render();
  });

  // ì´ˆê¸° ì„¤ì • ë¡œë“œ
  loadGithubConfigFromLocalStorage();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>1. Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸° (msgparser ì•ˆì • ë²„ì „)</title>

  <!-- ğŸ“Œ msgparser (ë¸Œë¼ìš°ì € 100% í˜¸í™˜ UMD ë²„ì „) -->
  <script src="./lib/DataStream.js"></script>
  <script src="./lib/MsgReader.js"></script>


  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,#1e40af,#0f766e);
      color:#fff;padding:12px 20px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .title{font-size:18px;font-weight:600}
    .subtitle{font-size:12px;opacity:.9}
    .file-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);padding:6px 12px;border-radius:20px;font-size:12px}
    main{display:flex;gap:16px;padding:16px}
    .sidebar{
      width:260px;background:#fff;border-radius:12px;padding:12px;
      height:calc(100vh - 70px);overflow:auto;box-shadow:0 2px 6px rgba(0,0,0,.1)
    }
    .content{flex:1;height:calc(100vh - 70px);overflow:auto}
    .section-title{font-weight:600;font-size:13px;margin:8px 0}
    .small-btn{
      padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;font-size:12px;
      background:#fff;cursor:pointer;width:100%
    }
    .small-btn:hover{background:#f3f4f6}
    .case-item{padding:6px;border-radius:8px;cursor:pointer;margin-bottom:4px}
    .case-item:hover{background:#e5e7eb}
    .case-item.active{background:#0f766e;color:#fff}
    #dropZone{
      border:2px dashed #9ca3af;background:#fff;padding:30px;
      border-radius:12px;text-align:center;font-size:13px;color:#6b7280;margin-bottom:12px
    }
    #dropZone.dragover{border-color:#2563eb;background:#eff6ff;color:#1d4ed8}
    .controls-row{display:flex;gap:8px;margin-bottom:10px}
    .search-input{
      flex:1;padding:6px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:13px
    }
    .toggle-group{display:flex;gap:6px;margin:10px 0}
    .toggle-btn{
      flex:1;padding:6px;border-radius:999px;border:1px solid #d1d5db;background:#fff;font-size:12px
    }
    .toggle-btn.active{background:#1e40af;color:#fff;border-color:#1e40af}
    .thread-item{padding:6px;border-radius:8px;margin-bottom:4px;cursor:pointer}
    .thread-item:hover{background:#f3f4f6}
    .thread-item.active{background:#1d4ed8;color:#fff}
    .summary-card{
      background:#fefce8;border:1px solid #facc15;padding:10px;border-radius:12px;
      font-size:12px;white-space:pre-wrap;margin-bottom:12px
    }
    .mail-card{
      background:#fff;border-radius:12px;padding:12px;margin-bottom:12px;
      box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:3px solid #e5e7eb;font-size:12px
    }
    .mail-header{display:flex;justify-content:space-between;margin-bottom:6px}
    .mail-subject{font-weight:600;margin-bottom:4px}
    .mail-meta{font-size:12px;color:#6b7280}
    .mail-date{font-size:12px;color:#374151;white-space:nowrap}
    .clickable{color:#2563eb;cursor:pointer;text-decoration:underline dotted;font-size:12px}
    .mail-body-full{display:none;border-top:1px dashed #ddd;padding-top:6px;margin-top:6px;white-space:pre-wrap}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#f3f4f6;margin-right:4px;font-size:11px}
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸°</div>
    <div class="subtitle">MSG/EML â†’ íƒ€ì„ë¼ì¸ + ìŠ¤ë ˆë“œ + GitHub ì €ì¥</div>
  </div>
  <div class="file-box">
    ğŸ“ <input id="fileInput" type="file" multiple accept=".msg,.eml" />
  </div>
</header>

<main>
  <!-- ì‚¬ì´ë“œë°” -->
  <aside class="sidebar">
    <div class="section-title">GitHub ì„¤ì •</div>
    <label style="font-size:12px">ê°œì¸ ì•¡ì„¸ìŠ¤ í† í°</label>
    <input id="ghToken" type="password" placeholder="github_pat_..." style="width:100%;padding:6px;border:1px solid #ddd;border-radius:6px">
    <button id="btnSaveGh" class="small-btn" style="margin-top:6px">í† í° ì €ì¥</button>
    <button id="btnLoadCases" class="small-btn" style="margin-top:6px">ì¼€ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <hr style="margin:16px 0">

    <div class="section-title">ì¼€ì´ìŠ¤ ê´€ë¦¬</div>
    <button id="btnAddCase" class="small-btn">â• ìƒˆ ì¼€ì´ìŠ¤</button>
    <div id="caseList" style="margin-top:10px"></div>

    <hr style="margin:16px 0">

    <div id="statsBox" style="font-size:12px;line-height:1.5;color:#444">
      GitHub í† í° ì…ë ¥ í›„ ì¼€ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.
    </div>

    <div class="section-title">ë³´ê¸° ëª¨ë“œ</div>
    <div class="toggle-group">
      <button id="btnTimeline" class="toggle-btn active">íƒ€ì„ë¼ì¸</button>
      <button id="btnThread" class="toggle-btn">ìŠ¤ë ˆë“œ</button>
    </div>

    <div class="section-title">ìŠ¤ë ˆë“œ ëª©ë¡</div>
    <div id="threadList"></div>
  </aside>

  <!-- ë³¸ë¬¸ -->
  <section class="content">

    <div id="dropZone">
      ì´ê³³ì— MSG / EML íŒŒì¼ì„ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”<br>
      <span style="font-size:11px;color:#aaa">ì„ íƒëœ ì¼€ì´ìŠ¤ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤</span>
    </div>

    <div class="controls-row">
      <input id="searchInput" class="search-input" placeholder="ì œëª© / ë³¸ë¬¸ / ë³´ë‚¸ì‚¬ëŒ ê²€ìƒ‰">
      <button id="btnClearSearch" class="small-btn">ì´ˆê¸°í™”</button>
    </div>

    <div id="viewInfo" style="font-size:12px;color:#444;margin-bottom:6px"></div>

    <div id="summaryContainer"></div>
    <div id="mailContainer"></div>
  </section>
</main>

<script>
/* --------------------------
   GitHub ì €ì¥ì†Œ ê¸°ë³¸ ì„¤ì •
-------------------------- */
let github = {
  user: "etech-symantec",
  repo: "case",
  branch: "main",
  token: ""
};

function ghHeaders(){
  const h = {"Accept":"application/vnd.github+json"};
  if(github.token) h["Authorization"] = "Bearer " + github.token;
  return h;
}
function ghUrl(path){
  return `https://api.github.com/repos/${github.user}/${github.repo}/contents/${path}`;
}

function b64e(str){return btoa(unescape(encodeURIComponent(str)));}
function b64d(b){return decodeURIComponent(escape(atob(b)));}

/* --------------------------
   GitHub JSON Load/Save
-------------------------- */
async function ghGet(path){
  const url = ghUrl(path) + "?ref=" + github.branch;
  const res = await fetch(url,{headers:ghHeaders()});
  if(res.status===404) return null;
  if(!res.ok) throw new Error("GET ì‹¤íŒ¨ "+res.status);
  const data = await res.json();
  return JSON.parse(b64d(data.content));
}

async function ghPut(path,obj,msg){
  if(!github.token){alert("í† í° í•„ìš”");return;}
  const url = ghUrl(path);

  let sha=null;
  const res0 = await fetch(url,{headers:ghHeaders()});
  if(res0.status===200){
    const j=await res0.json();
    sha=j.sha;
  }

  const body={
    message: msg || "update",
    content: b64e(JSON.stringify(obj,null,2)),
    branch: github.branch
  };
  if(sha) body.sha=sha;

  const res = await fetch(url,{
    method:"PUT",
    headers:{...ghHeaders(),"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  if(!res.ok){
    const t=await res.text();
    throw new Error("PUT ì‹¤íŒ¨ "+res.status+" "+t);
  }
}

/* --------------------------
   ì¼€ì´ìŠ¤ ë°ì´í„° êµ¬ì¡°
-------------------------- */
let casesMeta=[];    // [{id,name}]
let caseData={};     // id â†’ {id,name,emails}
let currentCaseId=null;

let allEmails=[];
let threads=[];
let currentView="timeline";
let currentThreadKey=null;

/* --------------------------
   ì´ë©”ì¼ íŒŒì‹± (msgparser)
-------------------------- */
function convertMsgToEmail(data, filename){
  const subject = data.subject || "(ì œëª© ì—†ìŒ)";
  const from = data.sender || "";
  const to = (data.recipients||[]).join("; ");
  const body = data.body || "";
  const dateStr = data.date || "";
  const dateObj = dateStr ? new Date(dateStr) : new Date(NaN);

  return {
    sourceType:"msg",
    filename,
    subject,
    from,
    to,
    body,
    dateStr,
    dateObj,
    preview: body.split("\n").slice(0,3).join(" "),
    threadKey: normalizeSubject(subject)
  };
}

function parseEml(raw, filename){
  const parts = raw.split(/\r?\n\r?\n/);
  let headers = parts[0]||"";
  let body = parts.slice(1).join("\n\n");

  function getHeader(name){
    const re=new RegExp("^"+name+":\\s*(.*)$","im");
    const m=headers.match(re);
    return m?m[1].trim():"";
  }

  const subject=getHeader("Subject")||"(ì œëª© ì—†ìŒ)";
  const from=getHeader("From");
  const to=getHeader("To");
  const dateStr=getHeader("Date");
  const dateObj=dateStr?new Date(dateStr):new Date(NaN);

  return {
    sourceType:"eml",
    filename,
    subject,
    from,
    to,
    body,
    dateStr,
    dateObj,
    preview: body.split("\n").slice(0,3).join(" "),
    threadKey: normalizeSubject(subject)
  };
}

function normalizeSubject(s){
  if(!s) return "(no-subject)";
  return s.toLowerCase().replace(/^(re|fw|fwd):/g,"").trim();
}

/* --------------------------
   íŒŒì¼ ì²˜ë¦¬ + ë“œë˜ê·¸ë“œë
-------------------------- */
async function handleFiles(files){
  if(!currentCaseId){alert("ì¼€ì´ìŠ¤ ë¨¼ì € ì„ íƒ");return;}

  allEmails = caseData[currentCaseId]?.emails || [];

  let remain = files.length;

  for(const file of files){
    const name=file.name;
    const ext=name.split(".").pop().toLowerCase();
    const reader=new FileReader();

    reader.onload=ev=>{
      try{
        if(ext==="msg"){
          const buf = ev.target.result;
          const p = new MsgParser(buf);
          const data=p.getJSON();
          allEmails.push(convertMsgToEmail(data,name));
        } else {
          const raw = ev.target.result;
          allEmails.push(parseEml(raw,name));
        }
      }catch(e){
        console.error("íŒŒì‹± ì‹¤íŒ¨",name,e);
      } finally {
        remain--;
        if(remain===0){
          caseData[currentCaseId].emails=allEmails;
          postProcess();
          ghPut(`cases/${currentCaseId}.json`,caseData[currentCaseId],"update case")
            .catch(err=>alert("GitHub ì €ì¥ ì‹¤íŒ¨: "+err.message));
        }
      }
    };

    if(ext==="msg") reader.readAsArrayBuffer(file);
    else reader.readAsText(file,"utf-8");
  }
}

/* --------------------------
   í›„ì²˜ë¦¬ / ë Œë”ë§
-------------------------- */
function postProcess(){
  if(!allEmails.length){
    document.getElementById("mailContainer").innerHTML="";
    return;
  }

  allEmails.sort((a,b)=>a.dateObj-b.dateObj);

  // thread grouping
  const map=new Map();
  allEmails.forEach(m=>{
    const k=m.threadKey;
    if(!map.has(k)) map.set(k,{threadKey:k,subject:m.subject,items:[]});
    map.get(k).items.push(m);
  });
  threads=[...map.values()];

  updateStats();
  renderThreads();
  renderView();
}

function updateStats(){
  statsBox.innerHTML = `ë©”ì¼: <b>${allEmails.length}</b>ê°œ<br>ìŠ¤ë ˆë“œ: <b>${threads.length}</b>ê°œ`;
}

function renderThreads(){
  const el=document.getElementById("threadList");
  el.innerHTML="";
  threads.forEach(t=>{
    const div=document.createElement("div");
    div.className="thread-item"+(t.threadKey===currentThreadKey?" active":"");
    div.textContent=`${t.subject} (${t.items.length})`;
    div.onclick=()=>{
      currentThreadKey=t.threadKey;
      currentView="thread";
      renderView();
      renderThreads();
    };
    el.appendChild(div);
  });
}

function renderView(){
  let list=[...allEmails];
  if(currentView==="thread" && currentThreadKey){
    const th=threads.find(x=>x.threadKey===currentThreadKey);
    list=th?th.items:[];
  }

  const kw=searchInput.value.toLowerCase().trim();
  if(kw){
    list=list.filter(m=>(m.subject+m.body+m.from+m.to).toLowerCase().includes(kw));
  }

  document.getElementById("viewInfo").textContent =
    `${currentView==="timeline"?"ì „ì²´ íƒ€ì„ë¼ì¸":"ìŠ¤ë ˆë“œ ë³´ê¸°"} (${list.length}í†µ)`;

  // thread summary
  const sumEl=document.getElementById("summaryContainer");
  sumEl.innerHTML="";
  if(currentView==="thread" && list.length){
    let s="";
    const first=list[0].dateObj,last=list[list.length-1].dateObj;
    s += `ê¸°ê°„: ${fmt(first)} ~ ${fmt(last)}\n`;
    s += `ë©”ì¼ ìˆ˜: ${list.length}\n\níë¦„:\n`;
    list.forEach((m,i)=>{s+=`[${i+1}] ${m.preview}\n`;});
    sumEl.innerHTML=`<div class="summary-card">${s}</div>`;
  }

  // mails
  const mc=document.getElementById("mailContainer");
  mc.innerHTML="";
  list.forEach((m,i)=>{
    const d=document.createElement("div");
    d.className="mail-card";
    d.innerHTML=`
      <div class="mail-header">
        <div>
          <div class="mail-subject">${esc(m.subject)}</div>
          <div class="mail-meta">From: ${esc(m.from)}<br>To: ${esc(m.to)}</div>
        </div>
        <div class="mail-date">${fmt(m.dateObj)}</div>
      </div>
      <div class="mail-body-preview">
        ${esc(m.preview)} <span class="clickable" id="toggle_${i}">ë”ë³´ê¸°</span>
      </div>
      <div class="mail-body-full" id="full_${i}">${esc(m.body)}</div>
      <div style="margin-top:6px">
        <span class="pill">${esc(m.filename)}</span>
        <span class="pill">${m.sourceType.toUpperCase()}</span>
      </div>
    `;
    mc.appendChild(d);

    document.getElementById(`toggle_${i}`).onclick=()=>{
      const full=document.getElementById(`full_${i}`);
      const show=full.style.display==="block";
      full.style.display=show?"none":"block";
    };
  });
}

function fmt(d){
  if(!(d instanceof Date)||isNaN(d)) return "ë‚ ì§œ ì—†ìŒ";
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}
function esc(s){return String(s||"").replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}

/* --------------------------
   ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° / ìƒì„±
-------------------------- */
async function loadCases(){
  try{
    const idx = await ghGet("cases/index.json");
    if(!idx){
      casesMeta=[];
      caseData={};
      currentCaseId=null;
      renderCaseList();
      return;
    }
    casesMeta=idx;
    caseData={};
    currentCaseId=null;
    renderCaseList();
  }catch(e){alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: "+e.message);}
}

function renderCaseList(){
  const el=document.getElementById("caseList");
  el.innerHTML="";
  casesMeta.forEach(c=>{
    const div=document.createElement("div");
    div.className="case-item"+(c.id===currentCaseId?" active":"");
    div.textContent=c.name;
    div.onclick=()=>selectCase(c.id);
    el.appendChild(div);
  });
}

async function selectCase(id){
  currentCaseId=id;
  renderCaseList();
  try{
    const obj=await ghGet(`cases/${id}.json`);
    if(obj){
      caseData[id]=obj;
      allEmails=obj.emails||[];
      postProcess();
    }
  }catch(e){alert("ì¼€ì´ìŠ¤ ë¡œë”© ì‹¤íŒ¨ "+e.message);}
}

async function addCase(){
  const name=prompt("ì¼€ì´ìŠ¤ ì´ë¦„?");
  if(!name) return;
  const id="case_"+Date.now();

  casesMeta.push({id,name});
  caseData[id]={id,name,emails:[]};
  currentCaseId=id;

  await ghPut("cases/index.json",casesMeta,"case index update");
  await ghPut(`cases/${id}.json`,caseData[id],"create case");

  renderCaseList();
}

/* --------------------------
   ì´ë²¤íŠ¸ ë°”ì¸ë”©
-------------------------- */
const fileInput=document.getElementById("fileInput");
const dropZone=document.getElementById("dropZone");
const searchInput=document.getElementById("searchInput");

document.getElementById("btnSaveGh").onclick=()=>{
  github.token = document.getElementById("ghToken").value.trim();
  localStorage.setItem("github_token",github.token);
  alert("ì €ì¥ë¨");
};
document.getElementById("btnLoadCases").onclick=loadCases;
document.getElementById("btnAddCase").onclick=addCase;

document.getElementById("btnTimeline").onclick=()=>{
  currentView="timeline";currentThreadKey=null;
  btnTimeline.classList.add("active");btnThread.classList.remove("active");
  renderView();
};
document.getElementById("btnThread").onclick=()=>{
  currentView="thread";
  btnThread.classList.add("active");btnTimeline.classList.remove("active");
  renderView();
};

searchInput.oninput=renderView;

document.getElementById("btnClearSearch").onclick=()=>{
  searchInput.value="";renderView();
};

fileInput.onchange=(e)=>handleFiles([...e.target.files]);

window.ondragover=e=>{e.preventDefault();dropZone.classList.add("dragover");};
window.ondragleave=()=>dropZone.classList.remove("dragover");
window.ondrop=e=>{
  e.preventDefault();dropZone.classList.remove("dragover");
  handleFiles([...e.dataTransfer.files]);
};

/* ì´ˆê¸° í† í° ë¡œë”© */
(function(){
  const t=localStorage.getItem("github_token");
  if(t){
    github.token=t;
    document.getElementById("ghToken").value=t;
  }
})();
</script>

</body>
</html>

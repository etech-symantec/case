<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸° (ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ì™„ë²½ ì§€ì›)</title>

  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f3f4f6;
      color: #111;
    }

    /* í—¤ë” ì˜ì—­ */
    header {
      position: sticky; top: 0; z-index: 100;
      background: linear-gradient(90deg, #1e40af, #0f766e);
      color: #fff;
      padding: 12px 20px;
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .title { font-size: 18px; font-weight: 600; }
    .subtitle { font-size: 12px; opacity: 0.9; margin-top: 2px; }
    
    .file-box {
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.2); padding: 6px 12px;
      border-radius: 999px; font-size: 12px;
      white-space: nowrap;
    }
    .file-box:hover { background: rgba(255,255,255,0.3); }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    main { display: flex; gap: 16px; padding: 16px; height: calc(100vh - 60px); }
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 280px; flex-shrink: 0;
      background: #fff; border-radius: 12px; padding: 12px;
      overflow-y: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-size: 12px;
      display: flex; flex-direction: column;
    }
    
    /* ì½˜í…ì¸  ì˜ì—­ */
    .content {
      flex: 1;
      display: flex; flex-direction: column;
      overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ */
    }

    /* ê³µí†µ UI ìš”ì†Œ */
    .section-title { font-weight: 700; font-size: 13px; margin: 12px 0 6px 0; color: #374151; }
    .section-title:first-child { margin-top: 0; }

    .small-btn {
      padding: 6px 10px; border-radius: 6px; border: 1px solid #d1d5db;
      font-size: 12px; background: #fff; cursor: pointer; width: 100%;
      transition: all 0.2s; color: #374151;
    }
    .small-btn:hover { background: #f3f4f6; border-color: #9ca3af; }
    .small-btn:active { background: #e5e7eb; }

    input[type="text"], input[type="password"], input[type="search"] {
      width: 100%; padding: 6px 8px; border: 1px solid #d1d5db;
      border-radius: 6px; font-size: 12px; margin-bottom: 4px;
    }
    input:focus { outline: 2px solid #2563eb; border-color: transparent; }

    /* ì¼€ì´ìŠ¤ ëª©ë¡ */
    .case-item {
      padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 2px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .case-item:hover { background: #f3f4f6; }
    .case-item.active { background: #0f766e; color: #fff; font-weight: 600; }

    /* ìŠ¤ë ˆë“œ/íƒ€ì„ë¼ì¸ í† ê¸€ */
    .toggle-group { display: flex; gap: 4px; margin-bottom: 8px; background: #e5e7eb; padding: 3px; border-radius: 8px; }
    .toggle-btn {
      flex: 1; border: none; background: transparent; padding: 6px;
      border-radius: 6px; font-size: 12px; cursor: pointer; color: #6b7280; font-weight: 500;
    }
    .toggle-btn.active { background: #fff; color: #1e40af; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* ìŠ¤ë ˆë“œ ëª©ë¡ */
    .thread-item {
      padding: 6px 8px; border-radius: 6px; margin-bottom: 2px; cursor: pointer;
      border-left: 3px solid transparent;
    }
    .thread-item:hover { background: #f3f4f6; }
    .thread-item.active { background: #eff6ff; border-left-color: #2563eb; color: #1e40af; font-weight: 600; }

    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¡´ */
    #dropZone {
      border: 2px dashed #9ca3af; background: #fff; padding: 24px;
      border-radius: 12px; text-align: center; font-size: 13px; color: #6b7280;
      margin-bottom: 12px; transition: all 0.2s; cursor: pointer;
    }
    #dropZone:hover { border-color: #6b7280; background: #f9fafb; }
    #dropZone.dragover { border-color: #2563eb; background: #eff6ff; color: #1d4ed8; transform: scale(1.01); }

    /* ê²€ìƒ‰ë°” */
    .controls-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-input { flex: 1; border-radius: 99px !important; padding-left: 16px !important; }

    /* ë©”ì¼ ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ì˜ì—­) */
    #mailContainer {
      flex: 1; overflow-y: auto; padding-right: 4px;
    }
    
    /* ë©”ì¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .mail-card {
      background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #e5e7eb; font-size: 13px;
    }
    .mail-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f3f4f6;
    }
    .mail-info { display: flex; flex-direction: column; gap: 4px; }
    .mail-label { color: #6b7280; font-size: 11px; font-weight: 600; width: 40px; display: inline-block; }
    .mail-date { font-size: 12px; color: #6b7280; white-space: nowrap; background: #f3f4f6; padding: 2px 8px; border-radius: 99px; }

    /* ë³¸ë¬¸ í”„ë¦¬ë·°/ì „ì²´ */
    .mail-body-preview { white-space: pre-wrap; color: #4b5563; line-height: 1.5; }
    .mail-body-full { display: none; margin-top: 12px; white-space: pre-wrap; line-height: 1.6; color: #1f2937; }
    .clickable { color: #2563eb; cursor: pointer; font-weight: 500; }
    .clickable:hover { text-decoration: underline; }

    /* ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ */
    .mail-images {
      margin-top: 16px; padding-top: 16px; border-top: 1px dashed #e5e7eb;
      display: flex; flex-wrap: wrap; gap: 12px;
    }
    .mail-img-box {
      border: 1px solid #e5e7eb; padding: 4px; border-radius: 8px; background: #fafafa;
    }
    .mail-img-box img {
      max-width: 100%; height: auto; max-height: 400px; display: block; border-radius: 4px; object-fit: contain;
    }
    .img-name { font-size: 11px; color: #6b7280; text-align: center; margin-top: 4px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* íƒœê·¸/ë±ƒì§€ */
    .pill {
      display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px;
      background: #f3f4f6; color: #4b5563; font-size: 11px; margin-right: 4px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 900px) {
      main { flex-direction: column; height: auto; }
      .sidebar { width: 100%; height: auto; max-height: 300px; }
      .content { height: auto; }
      #mailContainer { height: auto; overflow: visible; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">Outlook ì¼€ì´ìŠ¤ íƒ€ì„ë¼ì¸ ë¶„ì„ê¸°</div>
    <div class="subtitle">Base64 Text/Image Decode Â· GitHub Sync Â· EML Viewer</div>
  </div>
  <label class="file-box" style="cursor: pointer;">
    <span>ğŸ“ EML íŒŒì¼ ì¶”ê°€</span>
    <input id="fileInput" type="file" multiple accept=".eml" style="display: none;" />
  </label>
</header>

<main>
  <aside class="sidebar">
    <div class="section-title">GitHub ì—°ë™</div>
    <div style="margin-bottom: 4px;">
      <input id="ghToken" type="password" placeholder="GitHub Personal Access Token (PAT)" />
    </div>
    <div style="display: flex; gap: 4px;">
      <button id="btnSaveGh" class="small-btn">í† í° ì €ì¥</button>
      <button id="btnLoadCases" class="small-btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 12px 0;">

    <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
      <span>ì¼€ì´ìŠ¤ ëª©ë¡</span>
      <button id="btnAddCase" class="small-btn" style="width:auto; padding: 2px 8px;">+ ì¶”ê°€</button>
    </div>
    <div id="caseList">
      <div style="color:#9ca3af; padding:8px; text-align:center;">ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•˜ì„¸ìš”</div>
    </div>

    <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 12px 0;">

    <div id="statsBox" style="font-size: 11px; color: #6b7280; margin-bottom: 12px;"></div>

    <div class="section-title">ë³´ê¸° ë°©ì‹</div>
    <div class="toggle-group">
      <button id="btnTimeline" class="toggle-btn active">íƒ€ì„ë¼ì¸ (ì „ì²´)</button>
      <button id="btnThread" class="toggle-btn">ìŠ¤ë ˆë“œ (ì£¼ì œë³„)</button>
    </div>

    <div class="section-title">ìŠ¤ë ˆë“œ ëª©ë¡</div>
    <div id="threadList"></div>
  </aside>

  <section class="content">
    <div id="dropZone">
      ì´ê³³ì— <b>.eml</b> íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ì„¸ìš”<br>
      <span style="font-size: 11px; color: #9ca3af;">(MSG íŒŒì¼ì€ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ EMLë¡œ ë³€í™˜ í›„ ì˜¬ë ¤ì£¼ì„¸ìš”)</span>
    </div>

    <div class="controls-row">
      <input id="searchInput" class="search-input" type="search" placeholder="ì œëª©, ë³¸ë¬¸, ë³´ë‚¸ì‚¬ëŒ, ë°›ëŠ”ì‚¬ëŒ ê²€ìƒ‰..." />
      <button id="btnClearSearch" class="small-btn" style="width: auto;">ì´ˆê¸°í™”</button>
    </div>

    <div id="viewInfo" style="font-size: 14px; font-weight: 600; color: #111; margin-bottom: 10px; min-height: 20px;"></div>

    <div id="mailContainer"></div>
  </section>
</main>

<script type="module">
  // emailjs-mime-parser ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ES Module)
  import MimeParser from "https://esm.run/emailjs-mime-parser@2.0.6";

  // --------------------------------------------------------------------------
  // 1. GitHub API ìœ í‹¸ë¦¬í‹°
  // --------------------------------------------------------------------------
  const github = {
    user: "etech-symantec",
    repo: "case",
    branch: "main",
    token: ""
  };

  function ghHeaders() {
    const h = { "Accept": "application/vnd.github+json" };
    if (github.token) h["Authorization"] = "Bearer " + github.token;
    return h;
  }

  function ghUrl(path) {
    return `https://api.github.com/repos/${github.user}/${github.repo}/contents/${path}`;
  }

  // Unicode ë¬¸ìì—´ì„ Base64ë¡œ ì¸ì½”ë”©/ë””ì½”ë”© (í•œê¸€ ê¹¨ì§ ë°©ì§€)
  function b64e(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function b64d(b) {
    return decodeURIComponent(escape(atob(b)));
  }

  async function ghGet(path) {
    const url = ghUrl(path) + "?ref=" + github.branch;
    const res = await fetch(url, { headers: ghHeaders() });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error(`GET Error ${res.status}`);
    const data = await res.json();
    // GitHub APIëŠ” contentë¥¼ base64ë¡œ ì¤Œ
    if (!data.content) return null;
    // JSON íŒŒì‹±
    try {
      return JSON.parse(b64d(data.content));
    } catch (e) {
      console.error("JSON Parse Error:", e);
      return null;
    }
  }

  async function ghPut(path, obj, msg) {
    if (!github.token) {
      alert("GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    const url = ghUrl(path);
    let sha = null;

    // ê¸°ì¡´ íŒŒì¼ í™•ì¸ (SHA íšë“ìš©)
    try {
      const exist = await fetch(url, { headers: ghHeaders() });
      if (exist.ok) {
        const j = await exist.json();
        sha = j.sha;
      }
    } catch (e) { /* íŒŒì¼ ì—†ìŒ ë¬´ì‹œ */ }

    const body = {
      message: msg || "update via web tool",
      content: b64e(JSON.stringify(obj, null, 2)), // ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
      branch: github.branch
    };
    if (sha) body.sha = sha;

    const res = await fetch(url, {
      method: "PUT",
      headers: { ...ghHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`PUT Error ${res.status}: ${t}`);
    }
  }

  // --------------------------------------------------------------------------
  // 2. MIME ë””ì½”ë”© ë° íŒŒì‹± ìœ í‹¸ë¦¬í‹°
  // --------------------------------------------------------------------------
  
  // RFC 2047 í—¤ë” ë””ì½”ë”© (=?utf-8?B?....?=)
  function decodeMimeWord(str) {
    if (!str) return "";
    return str.replace(/=\?([^?]+)\?([BbQq])\?([^?]+)\?=/g, (m, charset, enc, text) => {
      try {
        charset = charset.toLowerCase();
        // KS_C_5601 ëŒ€ì‘
        if (charset.includes("ks_c_5601") || charset.includes("ks-c-5601")) charset = "euc-kr";

        const decoder = new TextDecoder(charset);
        if (enc.toUpperCase() === "B") {
          // Base64
          const bin = atob(text.replace(/\s+/g, ""));
          const bytes = Uint8Array.from([...bin].map(c => c.charCodeAt(0)));
          return decoder.decode(bytes);
        } else if (enc.toUpperCase() === "Q") {
          // Quoted-Printable
          let qp = text.replace(/_/g, " ");
          qp = qp.replace(/=([0-9A-Fa-f]{2})/g, (m, hex) => String.fromCharCode(parseInt(hex, 16)));
          // Qì¸ì½”ë”©ì€ ë³´í†µ ASCII ë²”ìœ„ì§€ë§Œ, ë“œë¬¼ê²Œ charset ì ìš© í•„ìš”í•  ìˆ˜ ìˆìŒ.
          // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ ë¬¸ìì—´ ì¹˜í™˜ í›„ ë””ì½”ë”© ì‹œë„
          const bytes = Uint8Array.from([...qp].map(c => c.charCodeAt(0)));
          return decoder.decode(bytes);
        }
      } catch (e) {
        console.warn("Header decode warning:", e);
      }
      return m;
    });
  }

  // ì´ë©”ì¼ ì£¼ì†Œ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± ("Name <email@com>, ...")
  function parseAddressList(raw) {
    if (!raw) return [];
    raw = decodeMimeWord(raw);
    // ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ë˜, <> ì•ˆì˜ ì‰¼í‘œëŠ” ë¬´ì‹œí•˜ëŠ” ì •ê·œì‹ì€ ë³µì¡í•˜ë¯€ë¡œ ë‹¨ìˆœ ë¶„ë¦¬ í›„ ë³´ì •
    const parts = raw.split(/,(?![^<]*>)/).map(s => s.trim()).filter(Boolean);
    
    return parts.map(p => {
      // "ì´ë¦„" <ì´ë©”ì¼> í˜•íƒœ ì¶”ì¶œ
      const m = p.match(/(.*)<(.+?)>/);
      if (m) {
        let name = m[1].trim().replace(/^["']|["']$/g, "");
        return { name, email: m[2].trim() };
      }
      return { name: "", email: p };
    });
  }

  // ì£¼ì†Œ ë¦¬ìŠ¤íŠ¸ í™”ë©´ í‘œì‹œìš© ë³€í™˜
  function renderAddresses(list) {
    if (!list || list.length === 0) return "";
    return list.map(x => x.name ? `${x.name} <${x.email}>` : x.email).join(", ");
  }

  // Base64 íŒ¨í„´ ê°ì§€ (ê°„ì´)
  function looksLikeBase64(str) {
    if (!str) return false;
    const s = str.replace(/\s+/g, "");
    if (s.length < 40) return false; // ë„ˆë¬´ ì§§ìœ¼ë©´ ë¬´ì‹œ
    // Base64 ë¬¸ì ì™¸ì˜ ê²ƒì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€
    if (/[^A-Za-z0-9+/=]/.test(s)) return false;
    // íŒ¨ë”©(=)ì´ ì¤‘ê°„ì— ë‚˜ì˜¤ê±°ë‚˜ ë„ˆë¬´ ë§ìœ¼ë©´ ì•„ë‹˜
    const eq = (s.match(/=/g) || []).length;
    if (eq > 2 && eq > s.length / 2) return false; 
    return true;
  }

  // --------------------------------------------------------------------------
  // 3. í•µì‹¬ ì „ì²˜ë¦¬: í…ìŠ¤íŠ¸ Base64 ë””ì½”ë”© (ì´ë¯¸ì§€ ì†ìƒ ë°©ì§€)
  // --------------------------------------------------------------------------
  function preprocessRawContent(raw) {
    if (!raw) return "";
    let processed = raw;

    // (A) íŒŒì¼ ì „ì²´ê°€ ê±°ëŒ€í•œ Base64 ë©ì–´ë¦¬ì¸ ê²½ìš° (ë“œë¬¼ì§€ë§Œ ì¡´ì¬)
    if (looksLikeBase64(processed)) {
      try {
        const cleaned = processed.replace(/\s+/g, "");
        const bin = atob(cleaned);
        const text = new TextDecoder("utf-8").decode(Uint8Array.from([...bin].map(c => c.charCodeAt(0))));
        
        // í…ìŠ¤íŠ¸ì¸ì§€ ë°”ì´ë„ˆë¦¬(ì´ë¯¸ì§€ ë“±)ì¸ì§€ íŒë‹¨: NULL ë¬¸ì(\0)ë‚˜ ëŒ€ì²´ë¬¸ì(\uFFFD) ìœ ë¬´
        if (!/\0/.test(text) && !text.includes("\uFFFD")) {
          processed = text;
        }
      } catch (e) { /* ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€ */ }
    }

    // (B) ë¶€ë¶„ì  Base64 ë¸”ë¡ ê°ì§€ ë° ì¹˜í™˜
    // 60ì ì´ìƒì˜ ì—°ì†ëœ Base64 ë¬¸ìì—´ ë¸”ë¡ì„ ì°¾ìŒ
    processed = processed.replace(/([A-Za-z0-9+\/=]{60,}[\r\n\s]*)+/g, (match) => {
      const cleaned = match.replace(/\s+/g, "");
      if (cleaned.length < 60) return match;
      if (!/^[A-Za-z0-9+\/=]+$/.test(cleaned)) return match;

      try {
        const bin = atob(cleaned);
        const u8 = Uint8Array.from([...bin].map(c => c.charCodeAt(0)));
        const text = new TextDecoder("utf-8").decode(u8);

        // ì¤‘ìš”: ë””ì½”ë”© ê²°ê³¼ì— ë°”ì´ë„ˆë¦¬ ë°ì´í„°(NULL char ë“±)ê°€ ì„ì—¬ ìˆë‹¤ë©´ ì´ë¯¸ì§€ê°€ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê±´ë„ˆëœ€
        // ì œì–´ ë¬¸ì(0x00 ~ 0x08, 0x0E ~ 0x1F)ê°€ í¬í•¨ë˜ë©´ ë°”ì´ë„ˆë¦¬ë¡œ ê°„ì£¼
        if (/[\x00-\x08\x0e-\x1f]/.test(text) || text.includes("\uFFFD")) {
          return match; // ì›ë³¸ ìœ ì§€ (íŒŒì„œê°€ ì²˜ë¦¬í•˜ë„ë¡)
        }
        
        // ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¼ë©´ ë””ì½”ë”©ëœ ê²°ê³¼ë¡œ ì¹˜í™˜
        return text;
      } catch (e) {
        return match;
      }
    });

    return processed;
  }

  // --------------------------------------------------------------------------
  // 4. ë…¸ë“œë³„ ì½˜í…ì¸  ë””ì½”ë”©
  // --------------------------------------------------------------------------
  function decodeNodeContent(node) {
    if (!node || node.content == null) return "";

    // Charset í™•ì¸
    let charset = (node.charset || (node.contentType?.params?.charset) || "utf-8").toLowerCase();
    if (charset.includes("ks_c_5601") || charset.includes("ks-c-5601")) charset = "euc-kr";

    // Transfer-Encoding í™•ì¸
    let encHeader = "";
    const cte = node.contentTransferEncoding || node.headers?.["content-transfer-encoding"];
    if (typeof cte === "string") encHeader = cte.toLowerCase();
    else if (Array.isArray(cte)) encHeader = (cte[0]?.value || cte[0] || "").toLowerCase();

    // 1) ì´ë¯¸ Uint8Arrayì¸ ê²½ìš° (íŒŒì„œê°€ ìë™ ë³€í™˜í•¨)
    if (node.content instanceof Uint8Array) {
      try {
        return new TextDecoder(charset).decode(node.content);
      } catch (err) {
        return new TextDecoder("utf-8").decode(node.content);
      }
    }

    // 2) ë¬¸ìì—´ì¸ ê²½ìš°
    let raw = (typeof node.content === "string") ? node.content : "";
    if (!raw) return "";

    // Base64 ëª…ì‹œ ë˜ëŠ” ê°ì§€
    const isB64 = encHeader.includes("base64") || looksLikeBase64(raw);
    if (isB64) {
      try {
        const cleaned = raw.replace(/\s+/g, "");
        const bin = atob(cleaned);
        const bytes = Uint8Array.from([...bin].map(c => c.charCodeAt(0)));
        return new TextDecoder(charset).decode(bytes);
      } catch (err) { /* ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜ */ }
    }

    // Quoted-Printable
    if (encHeader.includes("quoted-printable")) {
      let qp = raw.replace(/=\r?\n/g, "");
      qp = qp.replace(/=([0-9A-Fa-f]{2})/g, (m, hex) => String.fromCharCode(parseInt(hex, 16)));
      return qp;
    }

    return raw;
  }

  // --------------------------------------------------------------------------
  // 5. íŠ¸ë¦¬ ìˆœíšŒ: í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ìˆ˜ì§‘
  // --------------------------------------------------------------------------
  
  // í…ìŠ¤íŠ¸ ë³¸ë¬¸ ìˆ˜ì§‘ (text/plain)
  function collectTextPlain(node, arr) {
    if (!node) return;
    const ct = node.contentType || {};
    const type = (ct.type || "").toLowerCase();
    const sub = (ct.subtype || "").toLowerCase();

    if (type === "text" && sub === "plain") {
      const t = decodeNodeContent(node);
      if (t && t.trim()) arr.push(t);
    }
    
    if (node.childNodes) {
      node.childNodes.forEach(c => collectTextPlain(c, arr));
    }
  }

  // ì´ë¯¸ì§€ ìˆ˜ì§‘ (image/*)
  function collectImages(node, arr) {
    if (!node) return;
    const ct = node.contentType || {};
    const type = (ct.type || "").toLowerCase();

    // content-typeì´ imageì¸ ê²½ìš°
    if (type === "image") {
      let content = node.content;
      
      // emailjs-mime-parserëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ Uint8Arrayë¡œ ì£¼ê±°ë‚˜, ê°€ë” ë°°ì—´ë¡œ ì¤„ ìˆ˜ ìˆìŒ
      if (content) {
        if (!(content instanceof Uint8Array) && Array.isArray(content)) {
          content = new Uint8Array(content);
        }
        
        // ë¬¸ìì—´ ìƒíƒœë¡œ ì˜¨ ê²½ìš°(Base64) ë””ì½”ë”© ì‹œë„
        if (typeof content === "string") {
           try {
             const bin = atob(content.replace(/\s+/g, ""));
             content = Uint8Array.from([...bin].map(c => c.charCodeAt(0)));
           } catch(e) {}
        }

        if (content instanceof Uint8Array) {
          try {
            const mime = ct.value || "image/png"; // ê¸°ë³¸ê°’
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            
            // íŒŒì¼ëª… ì¶”ì¶œ
            let name = (ct.params && ct.params.name) || 
                       (node.headers && node.headers["content-disposition"] && node.headers["content-disposition"][0].params.filename) ||
                       "image";
            
            arr.push({ name, mime, url });
          } catch (e) {
            console.warn("ì´ë¯¸ì§€ Blob ë³€í™˜ ì‹¤íŒ¨", e);
          }
        }
      }
    }

    if (node.childNodes) {
      node.childNodes.forEach(c => collectImages(c, arr));
    }
  }

  // --------------------------------------------------------------------------
  // 6. ë³¸ë¬¸ ì •ì œ (Cleaning)
  // --------------------------------------------------------------------------
  function cleanupBody(body) {
    if (!body) return "";
    let out = body.replace(/\r\n/g, "\n");
    const lines = out.split("\n");
    const cleaned = [];

    for (let i = 0; i < lines.length; i++) {
      let t = lines[i].trim();

      // Multipart ê²½ê³„ì„  ë° ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
      if (/^\s*This is a multi-?part message/i.test(t)) continue;
      if (/^[-_]{3,}=Part/i.test(t)) continue;
      if (/^[-_]+=.*nextpart/i.test(t)) continue;
      if (/^boundary\s*=/i.test(t)) continue;
      if (/^content-(type|transfer|id|disposition)/i.test(t)) continue;
      if (/^mime-version:/i.test(t)) continue;
      
      // ì™¸ë¶€ ë©”ì¼ ê²½ê³  ë¬¸êµ¬ ì œê±° (ì˜ˆì‹œ)
      if (/NOTE: This email was received from an external source/i.test(t)) continue;

      // íšŒì‹ /ì „ë‹¬ ì‹œ í¬í•¨ëœ ì›ë³¸ ë©”ì¼ ì˜ì—­ ì œê±° (Outlook ìŠ¤íƒ€ì¼)
      if (/^[-_]{4,}\s*original message/i.test(t)) break;
      if (/^(from|to|sent|subject):\s/i.test(t) && i > 5) break; // í—¤ë”ê°€ ë³¸ë¬¸ ì¤‘ê°„ì— ë‚˜ì˜¤ë©´ ì»·
      if (/^on .* wrote:$/i.test(t)) break; // Gmail ìŠ¤íƒ€ì¼ ì¸ìš©

      cleaned.push(lines[i]);
    }

    out = cleaned.join("\n");
    
    // ë‚¨ì€ QP ì¸ì½”ë”© í”ì  ì •ë¦¬ (=20, =09 ë“±)
    out = out.replace(/=([0-9A-Fa-f]{2})/g, (m, hex) => {
      try { return String.fromCharCode(parseInt(hex, 16)); } catch { return m; }
    });
    // Soft line break ì œê±°
    out = out.replace(/=\n/g, "");

    // 3ê°œ ì´ìƒ ì—°ì† ì¤„ë°”ê¿ˆ ì¶•ì†Œ
    return out.replace(/\n{3,}/g, "\n\n").trim();
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„
  function esc(s) {
    return String(s || "").replace(/[&<>]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));
  }
  
  function fmtDate(d) {
    if (!(d instanceof Date) || isNaN(d)) return "ë‚ ì§œ ì •ë³´ ì—†ìŒ";
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")} ` +
           `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
  }

  // --------------------------------------------------------------------------
  // 7. EML íŒŒì‹± ì§„ì…ì 
  // --------------------------------------------------------------------------
  function parseEml(raw, filename) {
    // í—¤ë”ì™€ ë³¸ë¬¸ ë¶„ë¦¬ (Fallbackìš©)
    const parts = raw.split(/\r?\n\r?\n/);
    let headerBlock = parts[0] || "";
    let bodyFallback = parts.slice(1).join("\n\n") || "";
    headerBlock = headerBlock.replace(/(\r?\n)(\t| )+/g, " "); // ì ‘íŒ í—¤ë” í¼ì¹˜ê¸°

    // ì •ê·œì‹ìœ¼ë¡œ í—¤ë” ì¶”ì¶œ í•¨ìˆ˜
    const getH = (n) => {
      const m = headerBlock.match(new RegExp(`^${n}\\s*:\\s*(.+)$`, "im"));
      return m ? m[1].trim() : "";
    };

    let subject = decodeMimeWord(getH("Subject") || "(ì œëª© ì—†ìŒ)");
    let fromRaw = getH("From");
    let toRaw = getH("To");
    let ccRaw = getH("Cc");
    let dateStr = getH("Date");
    let dateObj = dateStr ? new Date(dateStr) : new Date(NaN);

    let bodyText = "";
    let images = [];

    try {
      // ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì„œ ì‹¤í–‰
      const parser = new MimeParser();
      parser.write(raw);
      parser.end();
      const root = parser.node;

      // ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ íŒŒì‹±í•œ í—¤ë” ìš°ì„  ì‚¬ìš©
      const pick = k => {
        const v = root.headers?.[k];
        if (!v) return null;
        if (Array.isArray(v)) return v[0]?.value || v[0];
        return v;
      };
      
      const sj = pick("subject");
      const fr = pick("from");
      const tr = pick("to");
      const cr = pick("cc");
      const dr = pick("date");

      if (sj) subject = decodeMimeWord(sj);
      if (fr) fromRaw = fr;
      if (tr) toRaw = tr;
      if (cr) ccRaw = cr;
      if (dr) {
        const d = new Date(dr);
        if (!isNaN(d)) dateObj = d;
      }

      // í…ìŠ¤íŠ¸ ìˆ˜ì§‘
      const plains = [];
      collectTextPlain(root, plains);
      if (plains.length > 0) {
        plains.sort((a, b) => b.length - a.length); // ê°€ì¥ ê¸´ í…ìŠ¤íŠ¸ê°€ ë³¸ë¬¸ì¼ í™•ë¥  ë†’ìŒ
        bodyText = plains[0];
      } else {
        bodyText = bodyFallback;
      }

      // ì´ë¯¸ì§€ ìˆ˜ì§‘
      collectImages(root, images);

    } catch (e) {
      console.warn("MimeParser Error (using fallback):", e);
      bodyText = bodyFallback;
      // Fallback ì‹œì—ëŠ” ì´ë¯¸ì§€ ì¶”ì¶œ ë¶ˆê°€
    }

    // ìµœì¢… ì •ë¦¬
    bodyText = cleanupBody(bodyText);
    
    // ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ìƒì„±
    const preview = bodyText.slice(0, 300).replace(/\s+/g, " ") + (bodyText.length > 300 ? "..." : "");

    return {
      sourceType: "eml",
      filename,
      subject,
      from: parseAddressList(fromRaw),
      to: parseAddressList(toRaw),
      cc: parseAddressList(ccRaw),
      body: bodyText,
      images, // Blob URL ë°°ì—´
      dateStr,
      dateObj,
      preview,
      // ìŠ¤ë ˆë“œ ê·¸ë£¹í•‘ìš© í‚¤ (Re: Fwd: ì œê±°ëœ ì œëª©)
      threadKey: subject.toLowerCase().replace(/^\s*(re|fw|fwd|ë‹µì¥|ì „ë‹¬|íšŒì‹ )(\s*:\s*)?/gi, "").replace(/^\[.*?\]\s*/, "").trim()
    };
  }


  // --------------------------------------------------------------------------
  // 8. ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ë° UI ì œì–´
  // --------------------------------------------------------------------------
  let casesMeta = [];      // [{id, name}]
  let caseData = {};       // { id: {id, name, emails: []} }
  let currentCaseId = null;
  let allEmails = [];      // í˜„ì¬ ì¼€ì´ìŠ¤ì˜ ì´ë©”ì¼ ëª©ë¡
  let threads = [];        // ìŠ¤ë ˆë“œë³„ ê·¸ë£¹í•‘ ë°ì´í„°
  let currentView = "timeline"; // 'timeline' or 'thread'
  let currentThreadKey = null;

  // DOM ìš”ì†Œ ì°¸ì¡°
  const elFileInput = document.getElementById("fileInput");
  const elDropZone = document.getElementById("dropZone");
  const elSearch = document.getElementById("searchInput");
  const elMailContainer = document.getElementById("mailContainer");
  const elStats = document.getElementById("statsBox");
  const elCaseList = document.getElementById("caseList");
  const elThreadList = document.getElementById("threadList");
  const elViewInfo = document.getElementById("viewInfo");

  // íŒŒì¼ ì²˜ë¦¬ í•¸ë“¤ëŸ¬
  async function handleFiles(files) {
    if (!currentCaseId) {
      alert("ë¨¼ì € ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    const targetEmails = caseData[currentCaseId].emails || [];
    let processedCount = 0;
    const total = files.length;
    
    // UI ì—…ë°ì´íŠ¸ (ë¡œë”© ì¤‘ í‘œì‹œ)
    elDropZone.textContent = "íŒŒì¼ ì²˜ë¦¬ ì¤‘...";

    for (const file of files) {
      if (!file.name.toLowerCase().endsWith(".eml")) {
        console.warn("Skipped non-eml file:", file.name);
        processedCount++;
        continue;
      }

      const reader = new FileReader();
      
      // Promiseë¡œ ê°ì‹¸ì„œ ìˆœì°¨/ë³‘ë ¬ ì²˜ë¦¬ ì œì–´
      await new Promise(resolve => {
        reader.onload = (e) => {
          try {
            let raw = e.target.result;
            // 1) í…ìŠ¤íŠ¸ Base64 ì„ ì²˜ë¦¬ (ì´ë¯¸ì§€ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            raw = preprocessRawContent(raw);
            // 2) íŒŒì‹±
            const mail = parseEml(raw, file.name);
            targetEmails.push(mail);
          } catch (err) {
            console.error("File Parse Error:", file.name, err);
          }
          resolve();
        };
        reader.onerror = resolve;
        reader.readAsText(file, "utf-8"); // ì¼ë‹¨ UTF-8ë¡œ ì½ê³  ë‚´ë¶€ì—ì„œ Base64 ë””ì½”ë”©
      });
      processedCount++;
    }

    // ì²˜ë¦¬ ì™„ë£Œ í›„ ì €ì¥
    caseData[currentCaseId].emails = targetEmails;
    allEmails = targetEmails;
    
    // GitHub ì €ì¥ ì‹œë„
    try {
      await ghPut(`cases/${currentCaseId}.json`, caseData[currentCaseId], "add emails");
      // ë©”íƒ€ë°ì´í„°ì— íŒŒì¼ ìˆ˜ ë“± ì—…ë°ì´íŠ¸í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ (ìƒëµ ê°€ëŠ¥)
    } catch (e) {
      alert("GitHub ì €ì¥ ì‹¤íŒ¨: " + e.message);
    }

    // UI ë³µêµ¬ ë° ë Œë”ë§
    elDropZone.innerHTML = "ì´ê³³ì— <b>.eml</b> íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ë†“ìœ¼ì„¸ìš”<br><span style='font-size:11px;color:#9ca3af'>(MSGëŠ” ì‚¬ì „ì— EMLë¡œ ë³€í™˜ í•„ìš”)</span>";
    postProcess();
  }

  // ë°ì´í„° í›„ì²˜ë¦¬ ë° í™”ë©´ ê°±ì‹ 
  function postProcess() {
    // ë‚ ì§œìˆœ ì •ë ¬
    allEmails.sort((a, b) => {
      const t1 = a.dateObj ? a.dateObj.getTime() : 0;
      const t2 = b.dateObj ? b.dateObj.getTime() : 0;
      return t1 - t2;
    });

    // ìŠ¤ë ˆë“œ ê·¸ë£¹í•‘
    const map = new Map();
    allEmails.forEach(m => {
      const k = m.threadKey || "(ì œëª© ì—†ìŒ)";
      if (!map.has(k)) map.set(k, { threadKey: k, subject: m.subject, items: [] });
      map.get(k).items.push(m);
    });
    threads = Array.from(map.values());

    updateStats();
    renderThreadList();
    renderMainView();
  }

  function updateStats() {
    elStats.innerHTML = `ì´ ë©”ì¼: <b>${allEmails.length}</b>ê°œ / ìŠ¤ë ˆë“œ: <b>${threads.length}</b>ê°œ`;
  }

  function renderThreadList() {
    elThreadList.innerHTML = "";
    threads.forEach(th => {
      const div = document.createElement("div");
      div.className = "thread-item" + (currentView === "thread" && th.threadKey === currentThreadKey ? " active" : "");
      div.textContent = `${th.subject} (${th.items.length})`;
      div.onclick = () => {
        currentThreadKey = th.threadKey;
        currentView = "thread";
        document.getElementById("btnThread").classList.add("active");
        document.getElementById("btnTimeline").classList.remove("active");
        renderThreadList(); // active í´ë˜ìŠ¤ ê°±ì‹  ìœ„í•´ ì¬í˜¸ì¶œ
        renderMainView();
      };
      elThreadList.appendChild(div);
    });
  }

  function renderMainView() {
    let list = [...allEmails];
    
    // ë·° ëª¨ë“œ í•„í„°ë§
    if (currentView === "thread" && currentThreadKey) {
      const th = threads.find(t => t.threadKey === currentThreadKey);
      list = th ? th.items : [];
      elViewInfo.textContent = `ğŸ“‚ ìŠ¤ë ˆë“œ: ${th ? th.subject : ""}`;
    } else {
      elViewInfo.textContent = "ğŸ•’ ì „ì²´ íƒ€ì„ë¼ì¸";
    }

    // ê²€ìƒ‰ì–´ í•„í„°ë§
    const kw = elSearch.value.trim().toLowerCase();
    if (kw) {
      list = list.filter(m => {
        const txt = (m.subject + m.body + renderAddresses(m.from) + renderAddresses(m.to)).toLowerCase();
        return txt.includes(kw);
      });
      elViewInfo.textContent += ` (ê²€ìƒ‰ê²°ê³¼: ${list.length}ê±´)`;
    }

    elMailContainer.innerHTML = "";
    if (list.length === 0) {
      elMailContainer.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>í‘œì‹œí•  ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    list.forEach((m, idx) => {
      const card = document.createElement("div");
      card.className = "mail-card";
      
      // ì´ë¯¸ì§€ HTML êµ¬ì„±
      let imagesHtml = "";
      if (m.images && m.images.length > 0) {
        imagesHtml = `<div class="mail-images">`;
        m.images.forEach(img => {
          imagesHtml += `
            <div class="mail-img-box">
              <a href="${img.url}" target="_blank">
                <img src="${img.url}" title="${esc(img.name)}" loading="lazy" />
              </a>
              <div class="img-name">${esc(img.name)}</div>
            </div>`;
        });
        imagesHtml += `</div>`;
      }

      card.innerHTML = `
        <div class="mail-header">
          <div class="mail-info">
            <div><span class="mail-label">From:</span> ${esc(renderAddresses(m.from))}</div>
            <div><span class="mail-label">To:</span> ${esc(renderAddresses(m.to))}</div>
            ${m.cc && m.cc.length ? `<div><span class="mail-label">CC:</span> ${esc(renderAddresses(m.cc))}</div>` : ""}
            <div style="margin-top:4px; font-weight:600; font-size:14px;">${esc(m.subject)}</div>
          </div>
          <div class="mail-date">${fmtDate(m.dateObj)}</div>
        </div>
        
        <div class="mail-body-preview">
          ${esc(m.preview)}
          <span class="clickable" onclick="document.getElementById('full_body_${idx}').style.display='block'; this.style.display='none'">...ë”ë³´ê¸°</span>
        </div>
        
        <div id="full_body_${idx}" class="mail-body-full">
          ${esc(m.body)}
          ${imagesHtml}
        </div>

        <div style="margin-top: 12px; border-top: 1px solid #f3f4f6; padding-top: 8px;">
           <span class="pill">ğŸ“„ ${esc(m.filename)}</span>
           ${m.images.length > 0 ? `<span class="pill">ğŸ–¼ï¸ ì´ë¯¸ì§€ ${m.images.length}ê°œ</span>` : ""}
        </div>
      `;
      elMailContainer.appendChild(card);
    });
  }

  // --------------------------------------------------------------------------
  // 9. ì¼€ì´ìŠ¤ ê´€ë¦¬ (GitHub ì—°ë™)
  // --------------------------------------------------------------------------
  async function loadCases() {
    try {
      const idx = await ghGet("cases/index.json");
      if (!idx) {
        // ì¸ë±ìŠ¤ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        casesMeta = [];
        caseData = {};
        currentCaseId = null;
      } else {
        casesMeta = idx;
        caseData = {};
        currentCaseId = null;
      }
      renderCaseList();
      alert("ì¼€ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
    } catch (e) {
      alert("ì¼€ì´ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + e.message);
    }
  }

  function renderCaseList() {
    elCaseList.innerHTML = "";
    if (casesMeta.length === 0) {
      elCaseList.innerHTML = "<div style='padding:8px; font-size:11px; color:#888;'>ìƒì„±ëœ ì¼€ì´ìŠ¤ ì—†ìŒ</div>";
      return;
    }
    casesMeta.forEach(c => {
      const div = document.createElement("div");
      div.className = "case-item" + (c.id === currentCaseId ? " active" : "");
      div.textContent = c.name;
      div.onclick = () => selectCase(c.id);
      elCaseList.appendChild(div);
    });
  }

  async function selectCase(id) {
    currentCaseId = id;
    renderCaseList();
    
    // ë°ì´í„° ë¡œë“œ
    if (!caseData[id]) {
      try {
        const data = await ghGet(`cases/${id}.json`);
        if (data) {
          caseData[id] = data;
          allEmails = data.emails || [];
          postProcess();
        }
      } catch (e) {
        alert("ì¼€ì´ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e.message);
      }
    } else {
      allEmails = caseData[id].emails || [];
      postProcess();
    }
  }

  async function addCase() {
    const name = prompt("ìƒˆ ì¼€ì´ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!name) return;
    const id = "case_" + Date.now();
    
    casesMeta.push({ id, name });
    caseData[id] = { id, name, emails: [] };
    
    // ì¸ë±ìŠ¤ ë° íŒŒì¼ ìƒì„± ì €ì¥
    try {
      await ghPut("cases/index.json", casesMeta, "add case index");
      await ghPut(`cases/${id}.json`, caseData[id], "create case file");
      currentCaseId = id;
      renderCaseList();
      // í™”ë©´ í´ë¦¬ì–´
      allEmails = [];
      postProcess();
    } catch (e) {
      alert("ì¼€ì´ìŠ¤ ìƒì„± ì €ì¥ ì‹¤íŒ¨: " + e.message);
    }
  }

  // --------------------------------------------------------------------------
  // 10. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  // --------------------------------------------------------------------------
  
  // GitHub í† í° ì €ì¥
  document.getElementById("btnSaveGh").onclick = () => {
    const t = document.getElementById("ghToken").value.trim();
    if (t) {
      github.token = t;
      localStorage.setItem("github_token", t);
      alert("í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€)");
    }
  };

  // ì´ˆê¸° í† í° ë¡œë“œ
  const savedToken = localStorage.getItem("github_token");
  if (savedToken) {
    github.token = savedToken;
    document.getElementById("ghToken").value = savedToken;
  }

  document.getElementById("btnLoadCases").onclick = loadCases;
  document.getElementById("btnAddCase").onclick = addCase;

  // ë·° ëª¨ë“œ ì „í™˜
  const btnTimeline = document.getElementById("btnTimeline");
  const btnThread = document.getElementById("btnThread");

  btnTimeline.onclick = () => {
    currentView = "timeline";
    currentThreadKey = null;
    btnTimeline.classList.add("active");
    btnThread.classList.remove("active");
    renderThreadList();
    renderMainView();
  };
  btnThread.onclick = () => {
    currentView = "thread";
    btnThread.classList.add("active");
    btnTimeline.classList.remove("active");
    renderMainView();
  };

  // ê²€ìƒ‰
  elSearch.oninput = renderMainView;
  document.getElementById("btnClearSearch").onclick = () => {
    elSearch.value = "";
    renderMainView();
  };

  // íŒŒì¼ ì…ë ¥ (ë²„íŠ¼)
  elFileInput.onchange = (e) => handleFiles([...e.target.files]);

  // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­
  window.ondragover = (e) => { e.preventDefault(); elDropZone.classList.add("dragover"); };
  window.ondragleave = () => elDropZone.classList.remove("dragover");
  window.ondrop = (e) => {
    e.preventDefault();
    elDropZone.classList.remove("dragover");
    handleFiles([...e.dataTransfer.files]);
  };

</script>
</body>
</html>
